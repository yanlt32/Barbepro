<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarbaPRO Duo - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="dash.css">

</head>
<body>
    <div class="container">
        <!-- Header Moderno -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">üíà</div>
                <div>
                    <h1>BarbaPRO Duo</h1>
                    <div class="logo-subtitle">Dashboard Profissional</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="btnVoltarRegistro">
                    ‚Üê Voltar ao Registro
                </button>
                <button class="btn btn-whatsapp" id="btnEnviarResumo">
                    üì± Resumo WhatsApp
                </button>
                <button class="btn btn-secondary" id="btnConfiguracoes">
                    ‚öôÔ∏è Configura√ß√µes
                </button>
            </div>
        </header>

        <!-- Notifica√ß√£o Push -->
        <div class="push-notification" id="pushNotification">
            <div class="push-header">
                <div class="push-title" id="pushNotificationTitle">‚ö†Ô∏è ALERTA DE VENCIMENTO</div>
                <button class="push-close" onclick="fecharNotificacao()">√ó</button>
            </div>
            <div id="pushNotificationMessage">Mensalistas vencidos detectados!</div>
        </div>

        <!-- Alertas Sonoros (simulado) -->
        <audio id="alertSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Card: Estat√≠sticas Gabriel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üë®‚Äçü¶± GABRIEL</div>
                    <div class="badge badge-success">HOJE</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="gabrielHoje">0</div>
                        <div class="stat-label">Servi√ßos Hoje</div>
                    </div>
                    <div class="stat-item stat-secondary">
                        <div class="stat-value" id="gabrielTotalHoje">R$ 0</div>
                        <div class="stat-label">Total Hoje</div>
                    </div>
                    <div class="stat-item stat-warning">
                        <div class="stat-value" id="gabrielFiadoHoje">R$ 0</div>
                        <div class="stat-label">Fiado Hoje</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gabrielMedia">R$ 0</div>
                        <div class="stat-label">M√©dia/Servi√ßo</div>
                    </div>
                </div>
            </div>

            <!-- Card: Estat√≠sticas Wagner -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üë®‚Äçü¶± WAGNER</div>
                    <div class="badge badge-success">HOJE</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="wagnerHoje">0</div>
                        <div class="stat-label">Servi√ßos Hoje</div>
                    </div>
                    <div class="stat-item stat-secondary">
                        <div class="stat-value" id="wagnerTotalHoje">R$ 0</div>
                        <div class="stat-label">Total Hoje</div>
                    </div>
                    <div class="stat-item stat-warning">
                        <div class="stat-value" id="wagnerFiadoHoje">R$ 0</div>
                        <div class="stat-label">Fiado Hoje</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="wagnerMedia">R$ 0</div>
                        <div class="stat-label">M√©dia/Servi√ßo</div>
                    </div>
                </div>
            </div>

            <!-- Card: Estat√≠sticas Gerais -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìä ESTAT√çSTICAS GERAIS</div>
                    <div class="badge badge-warning">M√äS ATUAL</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalMes">R$ 0</div>
                        <div class="stat-label">Total M√™s</div>
                    </div>
                    <div class="stat-item stat-secondary">
                        <div class="stat-value" id="servicosMes">0</div>
                        <div class="stat-label">Servi√ßos M√™s</div>
                    </div>
                    <div class="stat-item stat-warning">
                        <div class="stat-value" id="fiadoMes">R$ 0</div>
                        <div class="stat-label">Fiado Total</div>
                    </div>
                    <div class="stat-item stat-danger">
                        <div class="stat-value" id="despesasMes">R$ 0</div>
                        <div class="stat-label">Despesas M√™s</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Segunda Linha: Pagamentos e M√©todos -->
        <div class="dashboard-grid">
            <!-- Card: Resumo Pagamentos Hoje -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üí∞ PAGAMENTOS - HOJE</div>
                    <div class="badge badge-success">RESUMO</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item" onclick="filtrarPorMetodo('dinheiro')">
                        <div class="stat-value" id="totalDinheiro">R$ 0</div>
                        <div class="stat-label">üíµ DINHEIRO</div>
                    </div>
                    <div class="stat-item" onclick="filtrarPorMetodo('pix')">
                        <div class="stat-value" id="totalPix">R$ 0</div>
                        <div class="stat-label">üì± PIX</div>
                    </div>
                    <div class="stat-item" onclick="filtrarPorMetodo('debito')">
                        <div class="stat-value" id="totalDebito">R$ 0</div>
                        <div class="stat-label">üí≥ D√âBITO</div>
                    </div>
                    <div class="stat-item" onclick="filtrarPorMetodo('credito')">
                        <div class="stat-value" id="totalCredito">R$ 0</div>
                        <div class="stat-label">üí≥ CR√âDITO</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-whatsapp" id="btnEnviarPagamentos" style="width: 100%;">
                        üì± Enviar Relat√≥rio
                    </button>
                </div>
            </div>

            <!-- Card: Gr√°fico Distribui√ß√£o -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üìà DISTRIBUI√á√ÉO - HOJE</div>
                    <div class="badge badge-warning">GR√ÅFICO</div>
                </div>
                <div class="grafico-container">
                    <canvas id="graficoPizza"></canvas>
                </div>
            </div>

            <!-- Card: A√ß√µes R√°pidas -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">‚ö° A√á√ïES R√ÅPIDAS</div>
                    <div class="badge badge-success">MENU</div>
                </div>
                <div style="display: grid; gap: 15px; padding: 10px;">
                    <button class="btn btn-primary" id="btnVerResumoCompleto">
                        üìä Ver Resumo Completo
                    </button>
                    <button class="btn btn-success" id="btnRelatorioDetalhado">
                        üìÑ Relat√≥rio Detalhado
                    </button>
                    <button class="btn btn-whatsapp" id="btnEnviarMensalistas">
                        üë• Enviar Lembretes
                    </button>
                </div>
            </div>
        </div>

        <!-- Terceira Linha: Mensalistas - √ÅREA MELHORADA -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">üë• MENSALISTAS - GERENCIAMENTO INTELIGENTE</div>
                <div>
                    <button class="btn btn-success" id="btnNovoMensalista" style="margin-right: 10px;">
                        + Novo Mensalista
                    </button>
                    <button class="btn btn-whatsapp" id="btnNotificarTodos" onclick="notificarTodosMensalistas()">
                        üîî Notificar Todos
                    </button>
                </div>
            </div>
            
            <!-- Resumo de Status -->
            <div class="status-resumo" id="resumoStatusMensalistas">
                <!-- Din√¢mico -->
            </div>
            
            <!-- Filtros R√°pidos -->
            <div class="status-menu">
                <button class="status-btn active" onclick="filtrarMensalistasPorStatus('todos')">
                    üìã Todos
                    <span class="status-counter" id="counterTodos">0</span>
                </button>
                <button class="status-btn" onclick="filtrarMensalistasPorStatus('pago')">
                    ‚úÖ Pagos
                    <span class="status-counter" id="counterPagos">0</span>
                </button>
                <button class="status-btn" onclick="filtrarMensalistasPorStatus('pendente')">
                    ‚è≥ Pendentes
                    <span class="status-counter" id="counterPendentes">0</span>
                </button>
                <button class="status-btn" onclick="filtrarMensalistasPorStatus('vencido')">
                    ‚ö†Ô∏è Vencidos
                    <span class="status-counter" id="counterVencidos">0</span>
                </button>
                <button class="status-btn" onclick="filtrarMensalistasPorStatus('hoje')">
                    üìÖ Vence Hoje
                    <span class="status-counter" id="counterHoje">0</span>
                </button>
            </div>
            
            <!-- Filtros Avan√ßados -->
            <div class="filtro-container">
                <div class="filtro-grid">
                    <div class="input-group">
                        <label>üìÖ Data In√≠cio</label>
                        <input type="date" id="dataInicioMensalistas">
                    </div>
                    <div class="input-group">
                        <label>üìÖ Data Fim</label>
                        <input type="date" id="dataFimMensalistas">
                    </div>
                    <div class="input-group">
                        <label>üìä Status</label>
                        <select id="filtroStatusMensalistas">
                            <option value="todos">üìã Todos os Status</option>
                            <option value="pago">‚úÖ Pagos</option>
                            <option value="pendente">‚è≥ Pendentes</option>
                            <option value="vencido">‚ö†Ô∏è Vencidos</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>üë§ Barbeiro</label>
                        <select id="filtroBarbeiroMensalistas">
                            <option value="todos">üë• Todos Barbeiros</option>
                            <option value="Gabriel">üë®‚Äçü¶± Gabriel</option>
                            <option value="Wagner">üë®‚Äçü¶± Wagner</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn btn-primary" id="btnFiltrarMensalistas" style="flex: 1;">
                            üîç Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary" id="btnLimparFiltros" style="flex: 1;">
                            üóëÔ∏è Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Alertas de Vencimento -->
            <div id="alertasVencimento">
                <!-- Din√¢mico -->
            </div>
            
            <!-- Lista de Mensalistas -->
            <div id="listaMensalistasDashboard">
                <!-- Conte√∫do din√¢mico -->
            </div>
        </div>

        <!-- Quarta Linha: Servi√ßos Recentes -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">üìù SERVI√áOS RECENTES</div>
                <button class="btn btn-secondary" id="btnExportarServicos">
                    üì§ Exportar Dados
                </button>
            </div>
            
            <!-- Filtros Servi√ßos -->
            <div class="filtro-container">
                <div class="filtro-grid">
                    <div class="input-group">
                        <label>üìÖ Data In√≠cio</label>
                        <input type="date" id="dataInicioServicos">
                    </div>
                    <div class="input-group">
                        <label>üìÖ Data Fim</label>
                        <input type="date" id="dataFimServicos">
                    </div>
                    <div class="input-group">
                        <label>üë§ Barbeiro</label>
                        <select id="filtroBarbeiroServicos">
                            <option value="todos">üë• Todos Barbeiros</option>
                            <option value="Gabriel">üë®‚Äçü¶± Gabriel</option>
                            <option value="Wagner">üë®‚Äçü¶± Wagner</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>üí∞ Status Pagamento</label>
                        <select id="filtroPagamentoServicos">
                            <option value="todos">üìã Todos</option>
                            <option value="pago">‚úÖ Pagos</option>
                            <option value="fiado">‚è≥ Fiados</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn btn-primary" id="btnFiltrarServicos" style="flex: 1;">
                            üîç Filtrar Servi√ßos
                        </button>
                        <button class="btn btn-whatsapp" id="btnEnviarRelatorioServicos" style="flex: 1;">
                            üì± Enviar Relat√≥rio
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de Servi√ßos -->
            <div class="table-container">
                <div id="listaServicosRecentes">
                    <!-- Conte√∫do din√¢mico -->
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAIS ========== -->

    <!-- Modal: Resumo Completo -->
    <div class="modal" id="modalResumo">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä RESUMO COMPLETO - BARBEIROS</h2>
                <button class="close-btn" data-modal="modalResumo">&times;</button>
            </div>
            <div id="conteudoResumo">
                <!-- Din√¢mico -->
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" data-modal="modalResumo">
                    Fechar
                </button>
                <button class="btn btn-whatsapp" id="btnEnviarResumoCompleto">
                    üì± Enviar por WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Relat√≥rio Pagamentos -->
    <div class="modal" id="modalPagamentos">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üí∞ RELAT√ìRIO DE PAGAMENTOS DETALHADO</h2>
                <button class="close-btn" data-modal="modalPagamentos">&times;</button>
            </div>
            <div class="filtro-container">
                <div class="filtro-grid">
                    <div class="input-group">
                        <label>üìÖ Data In√≠cio</label>
                        <input type="date" id="dataInicioPagamentos">
                    </div>
                    <div class="input-group">
                        <label>üìÖ Data Fim</label>
                        <input type="date" id="dataFimPagamentos">
                    </div>
                    <div class="input-group">
                        <label>üë§ Barbeiro</label>
                        <select id="filtroBarbeiroPagamentos">
                            <option value="todos">üë• Todos Barbeiros</option>
                            <option value="Gabriel">üë®‚Äçü¶± Gabriel</option>
                            <option value="Wagner">üë®‚Äçü¶± Wagner</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn btn-primary" id="btnGerarRelatorio" style="flex: 1;">
                            üìà Gerar Relat√≥rio
                        </button>
                        <button class="btn btn-whatsapp" id="btnEnviarRelatorioWhatsApp" style="flex: 1;">
                            üì± Enviar WhatsApp
                        </button>
                    </div>
                </div>
            </div>
            <div id="relatorioPagamentosDetalhado">
                <!-- Conte√∫do din√¢mico -->
            </div>
        </div>
    </div>

    <!-- Modal: Mensalistas Detalhado -->
    <div class="modal" id="modalMensalistas">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üë• GERENCIAMENTO DE MENSALISTAS</h2>
                <button class="close-btn" data-modal="modalMensalistas">&times;</button>
            </div>
            
            <!-- Formul√°rio Novo Mensalista -->
            <div class="card" style="margin-bottom: 25px;">
                <div class="card-header">
                    <div class="card-title">‚ûï NOVO MENSALISTA</div>
                    <div class="badge badge-success">CADASTRO</div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>üë§ Nome do Cliente *</label>
                        <input type="text" id="nomeMensalista" placeholder="Nome completo do cliente">
                    </div>
                    <div class="form-group">
                        <label>üì± Telefone (WhatsApp)</label>
                        <input type="tel" id="telefoneMensalista" placeholder="(11) 99999-9999" maxlength="15">
                    </div>
                    <div class="form-group">
                        <label>üë®‚Äçü¶± Barbeiro *</label>
                        <select id="barbeiroMensalista">
                            <option value="Gabriel">Gabriel</option>
                            <option value="Wagner">Wagner</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üí∞ Valor Mensal (R$) *</label>
                        <input type="number" step="0.01" id="valorMensalista" placeholder="120.00">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Data de In√≠cio *</label>
                        <input type="date" id="dataInicioMensalista">
                    </div>
                    <div class="form-group">
                        <label>üìÖ Dia de Vencimento (1-31) *</label>
                        <input type="number" min="1" max="31" id="diaVencimentoMensalista" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label>üìä Status *</label>
                        <select id="statusMensalista">
                            <option value="pago">‚úÖ Pago</option>
                            <option value="pendente">‚è≥ Pendente</option>
                            <option value="vencido">‚ö†Ô∏è Vencido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìù Observa√ß√µes</label>
                        <textarea id="observacoesMensalista" rows="2" placeholder="Observa√ß√µes importantes..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="btnLimparFormMensalista">
                        Limpar Formul√°rio
                    </button>
                    <button class="btn btn-success" id="btnAdicionarMensalista">
                        ‚úÖ Cadastrar Mensalista
                    </button>
                </div>
            </div>
            
            <!-- Lista de Mensalistas -->
            <div id="listaMensalistasModal">
                <!-- Din√¢mico -->
            </div>
        </div>
    </div>

    <!-- Modal: Configura√ß√µes -->
    <div class="modal" id="modalConfig">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è CONFIGURA√á√ïES DO SISTEMA</h2>
                <button class="close-btn" data-modal="modalConfig">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>üì± N√∫mero WhatsApp Relat√≥rios</label>
                    <input type="tel" id="numWhats" placeholder="11974065186">
                </div>
                <div class="form-group">
                    <label>üîê Novo PIN (4 d√≠gitos)</label>
                    <input type="password" id="novoPin" maxlength="4" placeholder="****">
                </div>
                <div class="form-group">
                    <label>üí∞ Valor Corte</label>
                    <input type="number" step="0.01" id="valCorte" placeholder="Valor atual: R$ 28.00">
                </div>
                <div class="form-group">
                    <label>üí∞ Valor Barba</label>
                    <input type="number" step="0.01" id="valBarba" placeholder="Valor atual: R$ 15.00">
                </div>
                <div class="form-group">
                    <label>üí∞ Valor Combo</label>
                    <input type="number" step="0.01" id="valCombo" placeholder="Valor atual: R$ 40.00">
                </div>
                <div class="form-group">
                    <label>üîî Notifica√ß√µes de Vencimento</label>
                    <select id="notificacoesAtivas">
                        <option value="true">‚úÖ Ativas</option>
                        <option value="false">‚ùå Desativadas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>‚è∞ Dias antes para alerta</label>
                    <input type="number" min="1" max="7" id="diasAlerta" placeholder="3">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" data-modal="modalConfig">
                    Cancelar
                </button>
                <button class="btn btn-primary" id="btnSalvarConfiguracoes">
                    üíæ Salvar Configura√ß√µes
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript COMPLETO E FUNCIONAL -->
    <script>
        // ========== VARI√ÅVEIS GLOBAIS ==========
        let dados = { 
            Gabriel: [
                {
                    id: 1,
                    data: new Date().toISOString().split('T')[0],
                    hora: '10:30',
                    cliente: 'Jo√£o Silva',
                    tipo: 'Corte',
                    valor: 28.00,
                    pago: true,
                    metodoPagamento: 'dinheiro',
                    barbeiro: 'Gabriel',
                    observacoes: ''
                },
                {
                    id: 2,
                    data: new Date().toISOString().split('T')[0],
                    hora: '14:00',
                    cliente: 'Carlos Santos',
                    tipo: 'Barba + Cabelo',
                    valor: 40.00,
                    pago: false,
                    metodoPagamento: 'pix',
                    barbeiro: 'Gabriel',
                    observacoes: 'Fiado at√© dia 20'
                }
            ], 
            Wagner: [
                {
                    id: 1,
                    data: new Date().toISOString().split('T')[0],
                    hora: '11:00',
                    cliente: 'Pedro Costa',
                    tipo: 'Barba',
                    valor: 15.00,
                    pago: true,
                    metodoPagamento: 'credito',
                    barbeiro: 'Wagner',
                    observacoes: ''
                },
                {
                    id: 2,
                    data: new Date().toISOString().split('T')[0],
                    hora: '15:30',
                    cliente: 'Rafael Lima',
                    tipo: 'Corte',
                    valor: 28.00,
                    pago: true,
                    metodoPagamento: 'debito',
                    barbeiro: 'Wagner',
                    observacoes: ''
                }
            ], 
            despesas: [
                {
                    id: 1,
                    data: new Date().toISOString().split('T')[0],
                    descricao: 'Produtos para barbearia',
                    valor: 150.00,
                    categoria: 'Suprimentos'
                }
            ],
            mensalistas: [
                {
                    id: 1,
                    nome: 'Marcos Oliveira',
                    telefone: '(11) 99999-8888',
                    barbeiro: 'Gabriel',
                    valor: 120.00,
                    dataInicio: '2024-01-01',
                    diaVencimento: 10,
                    dataVencimento: '2024-02-10',
                    status: 'pago',
                    observacoes: 'Cliente preferencial',
                    historicoPagamentos: [
                        { data: '2024-01-10', valor: 120.00, pagoPor: 'Sistema' }
                    ]
                },
                {
                    id: 2,
                    nome: 'Roberto Santos',
                    telefone: '(11) 97777-6666',
                    barbeiro: 'Wagner',
                    valor: 100.00,
                    dataInicio: '2024-01-15',
                    diaVencimento: 15,
                    dataVencimento: '2024-02-15',
                    status: 'pendente',
                    observacoes: 'Pagar at√© dia 15',
                    historicoPagamentos: []
                },
                {
                    id: 3,
                    nome: 'Ant√¥nio Costa',
                    telefone: '(11) 95555-4444',
                    barbeiro: 'Gabriel',
                    valor: 150.00,
                    dataInicio: '2024-01-05',
                    diaVencimento: 5,
                    dataVencimento: '2024-02-05',
                    status: 'vencido',
                    observacoes: 'Atrasado 5 dias',
                    historicoPagamentos: []
                }
            ],
            config: { 
                pin: '1234', 
                whatsapp: '11974065186', 
                corte: 28, 
                barba: 15, 
                combo: 40,
                notificacoesAtivas: true,
                diasAlerta: 3
            }
        };

        let graficoPizza = null;
        let filtroMetodoAtual = null;
        let filtroStatusAtual = 'todos';
        let notificacaoAtiva = false;
        let editandoMensalistaId = null;

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard inicializando...');
            inicializarDashboard();
        });

        function inicializarDashboard() {
            // Carregar dados do localStorage se existir
            carregarDados();
            
            // Configurar datas
            configurarDatasDashboard();
            
            // Configurar event listeners
            configurarEventListenersDashboard();
            
            // Inicializar gr√°ficos
            inicializarGraficos();
            
            // Atualizar dashboard
            atualizarDashboardCompleto();
            
            // Iniciar verifica√ß√µes peri√≥dicas
            iniciarVerificacoesPeriodicas();
            
            console.log('‚úÖ Dashboard inicializado!');
        }

        function carregarDados() {
            try {
                const dadosSalvos = localStorage.getItem('barbapro_duo');
                if (dadosSalvos) {
                    const dadosParseados = JSON.parse(dadosSalvos);
                    // Mesclar dados salvos com dados padr√£o
                    Object.keys(dadosParseados).forEach(key => {
                        if (dados[key] !== undefined) {
                            dados[key] = dadosParseados[key];
                        }
                    });
                    console.log('üìÇ Dados carregados do localStorage');
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
            }
        }

        function salvarDados() {
            try {
                localStorage.setItem('barbapro_duo', JSON.stringify(dados));
                console.log('üíæ Dados salvos localmente');
            } catch (error) {
                console.error('‚ùå Erro ao salvar dados:', error);
            }
        }

        function configurarDatasDashboard() {
            const hoje = new Date();
            const umaSemanaAtras = new Date();
            umaSemanaAtras.setDate(hoje.getDate() - 7);
            
            // Configurar datas padr√£o
            const formatarData = (date) => date.toISOString().split('T')[0];
            
            // Servi√ßos recentes
            document.getElementById('dataInicioServicos').value = formatarData(umaSemanaAtras);
            document.getElementById('dataFimServicos').value = formatarData(hoje);
            
            // Pagamentos
            const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            document.getElementById('dataInicioPagamentos').value = formatarData(primeiroDiaMes);
            document.getElementById('dataFimPagamentos').value = formatarData(hoje);
            
            // Mensalistas
            document.getElementById('dataInicioMensalistas').value = formatarData(primeiroDiaMes);
            document.getElementById('dataFimMensalistas').value = formatarData(hoje);
            
            // Novo mensalista
            document.getElementById('dataInicioMensalista').value = formatarData(hoje);
            document.getElementById('diaVencimentoMensalista').value = hoje.getDate();
        }

        function configurarEventListenersDashboard() {
            // Bot√µes principais
            document.getElementById('btnVoltarRegistro').addEventListener('click', voltarParaRegistro);
            document.getElementById('btnConfiguracoes').addEventListener('click', abrirModalConfiguracoes);
            document.getElementById('btnEnviarResumo').addEventListener('click', () => abrirModalResumoCompleto());
            
            // Bot√µes de a√ß√£o r√°pida
            document.getElementById('btnVerResumoCompleto').addEventListener('click', () => abrirModalResumoCompleto());
            document.getElementById('btnRelatorioDetalhado').addEventListener('click', abrirModalPagamentos);
            document.getElementById('btnEnviarMensalistas').addEventListener('click', enviarLembretesMensalistas);
            
            // Bot√µes de mensalistas
            document.getElementById('btnNovoMensalista').addEventListener('click', abrirModalMensalistas);
            document.getElementById('btnFiltrarMensalistas').addEventListener('click', () => {
                filtrarMensalistasPorStatus('todos', true);
            });
            document.getElementById('btnLimparFiltros').addEventListener('click', limparFiltrosMensalistas);
            
            // Bot√µes de servi√ßos
            document.getElementById('btnFiltrarServicos').addEventListener('click', atualizarListaServicosRecentes);
            document.getElementById('btnEnviarRelatorioServicos').addEventListener('click', () => enviarRelatorioWhatsApp('servicos'));
            document.getElementById('btnExportarServicos').addEventListener('click', exportarDadosServicos);
            
            // Bot√µes de pagamentos
            document.getElementById('btnEnviarPagamentos').addEventListener('click', () => abrirModalPagamentos());
            document.getElementById('btnGerarRelatorio').addEventListener('click', gerarRelatorioPagamentosDetalhado);
            document.getElementById('btnEnviarRelatorioWhatsApp').addEventListener('click', () => enviarRelatorioWhatsApp('pagamentos'));
            
            // Bot√µes de formul√°rio
            document.getElementById('btnAdicionarMensalista').addEventListener('click', adicionarOuAtualizarMensalista);
            document.getElementById('btnLimparFormMensalista').addEventListener('click', limparFormMensalista);
            document.getElementById('btnSalvarConfiguracoes').addEventListener('click', salvarConfiguracoes);
            document.getElementById('btnEnviarResumoCompleto').addEventListener('click', () => enviarRelatorioWhatsApp('resumo'));
            
            // Bot√µes de fechar modal
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalId = this.getAttribute('data-modal');
                    fecharModal(modalId);
                });
            });
            
            // Input mask para telefone
            document.getElementById('telefoneMensalista').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 11) value = value.substring(0, 11);
                
                if (value.length > 10) {
                    value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
                } else if (value.length > 6) {
                    value = value.replace(/^(\d{2})(\d{4})(\d{0,4})$/, '($1) $2-$3');
                } else if (value.length > 2) {
                    value = value.replace(/^(\d{2})(\d{0,5})$/, '($1) $2');
                } else if (value.length > 0) {
                    value = value.replace(/^(\d{0,2})$/, '($1');
                }
                
                e.target.value = value;
            });
            
            // Fechar modais ao clicar fora
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
        }

        function iniciarVerificacoesPeriodicas() {
            // Verificar vencimentos a cada 5 minutos
            setInterval(verificarVencimentosMensalistas, 300000);
            
            // Atualizar dashboard a cada 30 segundos
            setInterval(() => {
                atualizarDashboardCompleto();
            }, 30000);
        }

        // ========== ATUALIZA√á√ÉO DO DASHBOARD ==========
        function atualizarDashboardCompleto() {
            atualizarEstatisticasBarbeiros();
            atualizarEstatisticasGerais();
            atualizarResumoPagamentos();
            atualizarListaServicosRecentes();
            atualizarResumoStatusMensalistas();
            filtrarMensalistasPorStatus(filtroStatusAtual);
            atualizarGraficoPizza();
            verificarVencimentosMensalistas();
        }

        function atualizarEstatisticasBarbeiros() {
            const hoje = new Date().toISOString().split('T')[0];
            
            // Gabriel
            const servicosGabrielHoje = dados.Gabriel.filter(s => s.data === hoje);
            const totalGabrielHoje = servicosGabrielHoje.reduce((sum, s) => sum + s.valor, 0);
            const fiadoGabrielHoje = servicosGabrielHoje.filter(s => !s.pago).reduce((sum, s) => sum + s.valor, 0);
            const mediaGabriel = servicosGabrielHoje.length > 0 ? (totalGabrielHoje / servicosGabrielHoje.length) : 0;
            
            // Atualizar Gabriel
            document.getElementById('gabrielHoje').textContent = servicosGabrielHoje.length;
            document.getElementById('gabrielTotalHoje').textContent = `R$ ${totalGabrielHoje.toFixed(2)}`;
            document.getElementById('gabrielFiadoHoje').textContent = `R$ ${fiadoGabrielHoje.toFixed(2)}`;
            document.getElementById('gabrielMedia').textContent = `R$ ${mediaGabriel.toFixed(2)}`;
            
            // Wagner
            const servicosWagnerHoje = dados.Wagner.filter(s => s.data === hoje);
            const totalWagnerHoje = servicosWagnerHoje.reduce((sum, s) => sum + s.valor, 0);
            const fiadoWagnerHoje = servicosWagnerHoje.filter(s => !s.pago).reduce((sum, s) => sum + s.valor, 0);
            const mediaWagner = servicosWagnerHoje.length > 0 ? (totalWagnerHoje / servicosWagnerHoje.length) : 0;
            
            // Atualizar Wagner
            document.getElementById('wagnerHoje').textContent = servicosWagnerHoje.length;
            document.getElementById('wagnerTotalHoje').textContent = `R$ ${totalWagnerHoje.toFixed(2)}`;
            document.getElementById('wagnerFiadoHoje').textContent = `R$ ${fiadoWagnerHoje.toFixed(2)}`;
            document.getElementById('wagnerMedia').textContent = `R$ ${mediaWagner.toFixed(2)}`;
        }

        function atualizarEstatisticasGerais() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            // Calcular totais do m√™s
            const servicosGabrielMes = dados.Gabriel.filter(s => {
                const dataServico = new Date(s.data);
                return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
            });
            
            const servicosWagnerMes = dados.Wagner.filter(s => {
                const dataServico = new Date(s.data);
                return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
            });
            
            const totalGabrielMes = servicosGabrielMes.reduce((sum, s) => sum + s.valor, 0);
            const totalWagnerMes = servicosWagnerMes.reduce((sum, s) => sum + s.valor, 0);
            const totalMes = totalGabrielMes + totalWagnerMes;
            const servicosMes = servicosGabrielMes.length + servicosWagnerMes.length;
            
            const fiadoMes = [...dados.Gabriel, ...dados.Wagner]
                .filter(s => {
                    const dataServico = new Date(s.data);
                    return dataServico.getMonth() === mesAtual && 
                           dataServico.getFullYear() === anoAtual && 
                           !s.pago;
                })
                .reduce((sum, s) => sum + s.valor, 0);
            
            const despesasMes = dados.despesas.filter(d => {
                const dataDespesa = new Date(d.data || d.dataCriacao);
                return dataDespesa.getMonth() === mesAtual && dataDespesa.getFullYear() === anoAtual;
            }).reduce((sum, d) => sum + d.valor, 0);
            
            document.getElementById('totalMes').textContent = `R$ ${totalMes.toFixed(2)}`;
            document.getElementById('servicosMes').textContent = servicosMes;
            document.getElementById('fiadoMes').textContent = `R$ ${fiadoMes.toFixed(2)}`;
            document.getElementById('despesasMes').textContent = `R$ ${despesasMes.toFixed(2)}`;
        }

        function atualizarResumoPagamentos() {
            const hoje = new Date().toISOString().split('T')[0];
            const todosServicos = [...dados.Gabriel, ...dados.Wagner];
            const servicosHoje = todosServicos.filter(s => s.data === hoje);
            
            // Calcular por m√©todo de pagamento
            const totalDinheiro = servicosHoje.filter(s => s.metodoPagamento === 'dinheiro').reduce((sum, s) => sum + s.valor, 0);
            const totalPix = servicosHoje.filter(s => s.metodoPagamento === 'pix').reduce((sum, s) => sum + s.valor, 0);
            const totalDebito = servicosHoje.filter(s => s.metodoPagamento === 'debito').reduce((sum, s) => sum + s.valor, 0);
            const totalCredito = servicosHoje.filter(s => s.metodoPagamento === 'credito').reduce((sum, s) => sum + s.valor, 0);
            
            document.getElementById('totalDinheiro').textContent = `R$ ${totalDinheiro.toFixed(2)}`;
            document.getElementById('totalPix').textContent = `R$ ${totalPix.toFixed(2)}`;
            document.getElementById('totalDebito').textContent = `R$ ${totalDebito.toFixed(2)}`;
            document.getElementById('totalCredito').textContent = `R$ ${totalCredito.toFixed(2)}`;
        }

        function inicializarGraficos() {
            const ctxPizza = document.getElementById('graficoPizza').getContext('2d');
            
            graficoPizza = new Chart(ctxPizza, {
                type: 'pie',
                data: {
                    labels: ['Gabriel', 'Wagner', 'Fiado'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            'rgba(255, 170, 0, 0.8)',
                            'rgba(51, 102, 255, 0.8)',
                            'rgba(255, 51, 102, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 170, 0, 1)',
                            'rgba(51, 102, 255, 1)',
                            'rgba(255, 51, 102, 1)'
                        ],
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#fff',
                                padding: 20,
                                font: {
                                    size: 13,
                                    family: "'Segoe UI', sans-serif"
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffaa00',
                            bodyColor: '#fff',
                            borderColor: '#ffaa00',
                            borderWidth: 1,
                            cornerRadius: 8,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
        }

        function atualizarGraficoPizza() {
            const hoje = new Date().toISOString().split('T')[0];
            
            const totalGabriel = dados.Gabriel.filter(s => s.data === hoje).reduce((sum, s) => sum + s.valor, 0);
            const totalWagner = dados.Wagner.filter(s => s.data === hoje).reduce((sum, s) => sum + s.valor, 0);
            const totalFiado = [...dados.Gabriel, ...dados.Wagner]
                .filter(s => s.data === hoje && !s.pago)
                .reduce((sum, s) => sum + s.valor, 0);
            
            if (graficoPizza) {
                graficoPizza.data.datasets[0].data = [totalGabriel, totalWagner, totalFiado];
                graficoPizza.update();
            }
        }

        // ========== FUN√á√ïES DE MENSALISTAS MELHORADAS ==========
        function atualizarResumoStatusMensalistas() {
            const hoje = new Date();
            const mensalistas = dados.mensalistas;
            
            // Contar por status
            const pagos = mensalistas.filter(m => m.status === 'pago').length;
            const pendentes = mensalistas.filter(m => m.status === 'pendente').length;
            const vencidos = mensalistas.filter(m => m.status === 'vencido').length;
            
            // Contar vencimentos hoje
            const vencemHoje = mensalistas.filter(m => {
                if (m.status === 'pago') return false;
                const dataVenc = new Date(m.dataVencimento || m.vencimento);
                const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                return diffDias === 0;
            }).length;
            
            // Atualizar contadores
            document.getElementById('counterTodos').textContent = mensalistas.length;
            document.getElementById('counterPagos').textContent = pagos;
            document.getElementById('counterPendentes').textContent = pendentes;
            document.getElementById('counterVencidos').textContent = vencidos;
            document.getElementById('counterHoje').textContent = vencemHoje;
            
            // Atualizar resumo visual
            const html = `
                <div class="status-card pago">
                    <div class="status-card-label">‚úÖ PAGOS</div>
                    <div class="status-card-total">${pagos}</div>
                </div>
                <div class="status-card pendente">
                    <div class="status-card-label">‚è≥ PENDENTES</div>
                    <div class="status-card-total">${pendentes}</div>
                </div>
                <div class="status-card vencido">
                    <div class="status-card-label">‚ö†Ô∏è VENCIDOS</div>
                    <div class="status-card-total">${vencidos}</div>
                </div>
                <div class="status-card" style="border-top: 4px solid #ffaa00;">
                    <div class="status-card-label">üìÖ VENCE HOJE</div>
                    <div class="status-card-total" style="color: #ffaa00;">${vencemHoje}</div>
                </div>
            `;
            
            document.getElementById('resumoStatusMensalistas').innerHTML = html;
        }

        function filtrarMensalistasPorStatus(status, usarFiltrosAvancados = false) {
            filtroStatusAtual = status;
            
            // Atualizar bot√µes ativos
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const btnAtivo = Array.from(document.querySelectorAll('.status-btn')).find(btn => 
                btn.textContent.includes(status === 'todos' ? 'Todos' : 
                                        status === 'pago' ? 'Pagos' : 
                                        status === 'pendente' ? 'Pendentes' : 
                                        status === 'vencido' ? 'Vencidos' : 'Vence Hoje')
            );
            
            if (btnAtivo) btnAtivo.classList.add('active');
            
            // Aplicar filtros
            const hoje = new Date();
            let mensalistasFiltrados = [...dados.mensalistas];
            
            // Filtro por status
            if (status !== 'todos') {
                if (status === 'hoje') {
                    mensalistasFiltrados = mensalistasFiltrados.filter(m => {
                        if (m.status === 'pago') return false;
                        const dataVenc = new Date(m.dataVencimento || m.vencimento);
                        const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                        return diffDias === 0;
                    });
                } else {
                    mensalistasFiltrados = mensalistasFiltrados.filter(m => m.status === status);
                }
            }
            
            // Aplicar filtros avan√ßados se solicitado
            if (usarFiltrosAvancados) {
                const dataInicio = document.getElementById('dataInicioMensalistas').value;
                const dataFim = document.getElementById('dataFimMensalistas').value;
                const filtroStatusAvancado = document.getElementById('filtroStatusMensalistas').value;
                const filtroBarbeiro = document.getElementById('filtroBarbeiroMensalistas').value;
                
                if (dataInicio && dataFim) {
                    mensalistasFiltrados = mensalistasFiltrados.filter(mensalista => {
                        const dataVenc = new Date(mensalista.dataVencimento || mensalista.vencimento || mensalista.dataInicio);
                        const dataInicioDate = new Date(dataInicio);
                        const dataFimDate = new Date(dataFim);
                        
                        if (dataVenc < dataInicioDate || dataVenc > dataFimDate) return false;
                        if (filtroStatusAvancado !== 'todos' && mensalista.status !== filtroStatusAvancado) return false;
                        if (filtroBarbeiro !== 'todos' && mensalista.barbeiro !== filtroBarbeiro) return false;
                        
                        return true;
                    });
                }
            }
            
            // Ordenar por status (vencidos primeiro) e data
            mensalistasFiltrados.sort((a, b) => {
                // Ordem por status: vencido > pendente > pago
                const statusOrder = { 'vencido': 1, 'pendente': 2, 'pago': 3 };
                if (statusOrder[a.status] !== statusOrder[b.status]) {
                    return statusOrder[a.status] - statusOrder[b.status];
                }
                
                // Por data de vencimento
                const dataA = new Date(a.dataVencimento || a.vencimento);
                const dataB = new Date(b.dataVencimento || b.vencimento);
                return dataA - dataB;
            });
            
            // Gerar HTML
            let html = '';
            
            if (mensalistasFiltrados.length > 0) {
                mensalistasFiltrados.forEach(mensalista => {
                    const statusClass = mensalista.status === 'pago' ? 'status-pago' : 
                                      mensalista.status === 'pendente' ? 'status-pendente' : 'status-vencido';
                    const statusTexto = mensalista.status === 'pago' ? '‚úÖ PAGO' : 
                                       mensalista.status === 'pendente' ? '‚è≥ PENDENTE' : '‚ö†Ô∏è VENCIDO';
                    
                    const dataVencimento = mensalista.dataVencimento || mensalista.vencimento;
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    const vencimento = new Date(dataVencimento);
                    vencimento.setHours(0, 0, 0, 0);
                    const diffDias = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
                    
                    let vencimentoTexto = '';
                    let vencimentoClass = '';
                    
                    if (mensalista.status === 'pago') {
                        vencimentoTexto = `üìÖ Pr√≥ximo: ${formatarDataBR(calcularProximoVencimento(dataVencimento))}`;
                    } else if (diffDias > 0) {
                        vencimentoTexto = `üìÖ Vence em ${diffDias} ${diffDias === 1 ? 'dia' : 'dias'}`;
                        vencimentoClass = diffDias <= 3 ? 'proximo' : '';
                    } else if (diffDias === 0) {
                        vencimentoTexto = '‚ö†Ô∏è VENCE HOJE!';
                        vencimentoClass = 'hoje';
                    } else {
                        vencimentoTexto = `‚è∞ Vencido h√° ${Math.abs(diffDias)} ${Math.abs(diffDias) === 1 ? 'dia' : 'dias'}`;
                        vencimentoClass = 'vencido';
                    }
                    
                    // Determinar classe do card
                    let cardClass = 'mensalista-card';
                    if (mensalista.status === 'vencido') cardClass += ' vencido';
                    if (mensalista.status === 'pendente' && diffDias <= 3) cardClass += ' pendente';
                    
                    html += `
                        <div class="${cardClass}" id="mensalista-${mensalista.id}">
                            <div class="mensalista-header">
                                <div>
                                    <div class="mensalista-nome">${mensalista.nome}</div>
                                    <span class="badge ${mensalista.barbeiro === 'Gabriel' ? 'badge-warning' : 'badge-success'}" style="margin-top: 5px;">
                                        ${mensalista.barbeiro}
                                    </span>
                                </div>
                                <div class="mensalista-actions">
                                    <span class="status-tag ${statusClass}">${statusTexto}</span>
                                    ${mensalista.status !== 'pago' ? `
                                        <button class="action-btn success" onclick="pagarMensalidade(${mensalista.id})" data-tooltip="Pagar mensalidade">
                                            üí∞
                                        </button>
                                    ` : ''}
                                    ${mensalista.telefone ? `
                                        <button class="action-btn whatsapp" onclick="enviarLembreteMensalista(${mensalista.id})" data-tooltip="Enviar lembrete">
                                            üì±
                                        </button>
                                    ` : ''}
                                    <button class="action-btn edit" onclick="editarMensalista(${mensalista.id})" data-tooltip="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button class="action-btn" onclick="removerMensalista(${mensalista.id})" data-tooltip="Remover mensalista" style="background: rgba(255,0,0,0.2); color: #ff0000;">
                                        √ó
                                    </button>
                                </div>
                            </div>
                            <div class="mensalista-detalhes">
                                <div class="mensalista-detalhes-item">
                                    <div class="mensalista-detalhes-label">Valor Mensal</div>
                                    <div class="mensalista-valor">R$ ${mensalista.valor.toFixed(2)}</div>
                                </div>
                                <div class="mensalista-detalhes-item">
                                    <div class="mensalista-detalhes-label">Vencimento</div>
                                    <div class="mensalista-detalhes-value">${formatarDataBR(dataVencimento)}</div>
                                </div>
                                <div class="mensalista-detalhes-item">
                                    <div class="mensalista-detalhes-label">Status</div>
                                    <div class="mensalista-vencimento ${vencimentoClass}">${vencimentoTexto}</div>
                                </div>
                                ${mensalista.telefone ? `
                                    <div class="mensalista-detalhes-item">
                                        <div class="mensalista-detalhes-label">Contato</div>
                                        <div class="mensalista-telefone">${mensalista.telefone}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${mensalista.observacoes ? `
                                <div style="font-size: 12px; color: #888; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    üìù ${mensalista.observacoes}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                html = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <div class="empty-state-title">Nenhum mensalista encontrado</div>
                        <div class="empty-state-subtitle">
                            ${status === 'vencido' ? '‚úÖ Todos os mensalistas est√£o em dia!' : 
                              status === 'hoje' ? 'üéâ Ningu√©m vence hoje!' : 
                              'Tente ajustar os filtros ou cadastre um novo mensalista'}
                        </div>
                        <button class="btn btn-success" onclick="abrirModalMensalistas()" style="margin-top: 20px;">
                            + Adicionar Mensalista
                        </button>
                    </div>
                `;
            }
            
            document.getElementById('listaMensalistasDashboard').innerHTML = html;
        }

        function limparFiltrosMensalistas() {
            document.getElementById('dataInicioMensalistas').value = '';
            document.getElementById('dataFimMensalistas').value = '';
            document.getElementById('filtroStatusMensalistas').value = 'todos';
            document.getElementById('filtroBarbeiroMensalistas').value = 'todos';
            
            filtrarMensalistasPorStatus('todos');
        }

        function verificarVencimentosMensalistas() {
            if (!dados.config.notificacoesAtivas) return;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const diasAlerta = dados.config.diasAlerta || 3;
            
            let alertasHTML = '';
            let vencidosParaNotificar = [];
            let proximosParaNotificar = [];
            
            dados.mensalistas.forEach(mensalista => {
                if (mensalista.status === 'pago') return;
                
                const dataVencimento = new Date(mensalista.dataVencimento || mensalista.vencimento);
                dataVencimento.setHours(0, 0, 0, 0);
                
                const diffDias = Math.ceil((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
                
                // Atualizar status se necess√°rio
                if (diffDias < 0 && mensalista.status !== 'vencido') {
                    mensalista.status = 'vencido';
                    vencidosParaNotificar.push(mensalista);
                } else if (diffDias === 0 && mensalista.status !== 'vencido') {
                    mensalista.status = 'pendente';
                    proximosParaNotificar.push(mensalista);
                } else if (diffDias > 0 && diffDias <= diasAlerta && mensalista.status === 'pendente') {
                    proximosParaNotificar.push(mensalista);
                }
            });
            
            // Salvar altera√ß√µes de status
            if (vencidosParaNotificar.length > 0 || proximosParaNotificar.length > 0) {
                salvarDados();
            }
            
            // Gerar alertas visuais
            if (vencidosParaNotificar.length > 0) {
                alertasHTML += `
                    <div class="notificacao">
                        <div class="notificacao-titulo">‚ö†Ô∏è ${vencidosParaNotificar.length} MENSALISTA(S) VENCIDO(S)</div>
                        <div style="display: grid; gap: 8px; margin-top: 10px;">
                            ${vencidosParaNotificar.slice(0, 3).map(m => `
                                <div class="notificacao-mensalista">
                                    <div>
                                        <div style="font-weight: 600;">${m.nome}</div>
                                        <div style="font-size: 12px; color: #ff9999;">
                                            ${m.barbeiro} ‚Ä¢ Venceu ${formatarDataBR(m.dataVencimento)}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="action-btn success" onclick="pagarMensalidade(${m.id})">
                                            üí∞
                                        </button>
                                        <button class="action-btn whatsapp" onclick="enviarLembreteMensalista(${m.id})">
                                            üì±
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${vencidosParaNotificar.length > 3 ? `
                            <div style="text-align: center; margin-top: 10px; color: #ff9999; font-size: 12px;">
                                + ${vencidosParaNotificar.length - 3} outros vencidos
                            </div>
                        ` : ''}
                        <button class="btn btn-danger" onclick="filtrarMensalistasPorStatus('vencido')" style="margin-top: 15px; width: 100%;">
                            üëÅÔ∏è Ver Todos os Vencidos
                        </button>
                    </div>
                `;
            }
            
            if (proximosParaNotificar.length > 0) {
                alertasHTML += `
                    <div class="notificacao" style="background: linear-gradient(135deg, rgba(255,149,0,0.1), rgba(255,149,0,0.05)); border-color: rgba(255,149,0,0.3);">
                        <div class="notificacao-titulo" style="color: #FF9500;">‚è∞ ${proximosParaNotificar.length} VENCIMENTO(S) PR√ìXIMO(S)</div>
                        <div style="display: grid; gap: 8px; margin-top: 10px;">
                            ${proximosParaNotificar.slice(0, 3).map(m => {
                                const dataVenc = new Date(m.dataVencimento || m.vencimento);
                                const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                                return `
                                    <div class="notificacao-mensalista" style="background: rgba(255,149,0,0.1);">
                                        <div>
                                            <div style="font-weight: 600;">${m.nome}</div>
                                            <div style="font-size: 12px; color: #ffb366;">
                                                ${m.barbeiro} ‚Ä¢ Vence em ${diffDias} ${diffDias === 1 ? 'dia' : 'dias'}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 5px;">
                                            <button class="action-btn whatsapp" onclick="enviarLembreteMensalista(${m.id})">
                                                üì±
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('alertasVencimento').innerHTML = alertasHTML;
            
            // Mostrar notifica√ß√£o push se houver vencidos
            if (vencidosParaNotificar.length > 0 && !notificacaoAtiva) {
                mostrarNotificacaoPush(vencidosParaNotificar);
            }
            
            // Atualizar listas
            atualizarResumoStatusMensalistas();
            if (filtroStatusAtual !== 'todos') {
                filtrarMensalistasPorStatus(filtroStatusAtual);
            }
        }

        function mostrarNotificacaoPush(mensalistas) {
            if (!dados.config.notificacoesAtivas) return;
            
            const notificacao = document.getElementById('pushNotification');
            const title = document.getElementById('pushNotificationTitle');
            const message = document.getElementById('pushNotificationMessage');
            
            if (mensalistas.length === 1) {
                title.innerHTML = '‚ö†Ô∏è MENSALISTA VENCIDO';
                message.textContent = `${mensalistas[0].nome} est√° com mensalidade vencida!`;
            } else {
                title.innerHTML = `‚ö†Ô∏è ${mensalistas.length} MENSALISTAS VENCIDOS`;
                message.textContent = `${mensalistas.slice(0, 2).map(m => m.nome).join(', ')}${mensalistas.length > 2 ? ' e outros' : ''} est√£o vencidos!`;
            }
            
            notificacao.style.display = 'block';
            notificacaoAtiva = true;
            
            // Tocar som de alerta
            try {
                document.getElementById('alertSound').play();
            } catch (error) {
                console.log('Som de alerta n√£o dispon√≠vel');
            }
            
            // Auto-fechar ap√≥s 10 segundos
            setTimeout(() => {
                fecharNotificacao();
            }, 10000);
        }

        function fecharNotificacao() {
            const notificacao = document.getElementById('pushNotification');
            notificacao.style.display = 'none';
            notificacaoAtiva = false;
        }

        function notificarTodosMensalistas() {
            const mensalistasPendentes = dados.mensalistas.filter(m => m.status === 'pendente' || m.status === 'vencido');
            
            if (mensalistasPendentes.length === 0) {
                alert('‚úÖ N√£o h√° mensalistas pendentes para notificar!');
                return;
            }
            
            if (!confirm(`üì¢ Enviar notifica√ß√µes para ${mensalistasPendentes.length} mensalista(s)?\n\nEsta a√ß√£o enviar√° mensagens de lembrete via WhatsApp.`)) {
                return;
            }
            
            // Filtrar apenas os que t√™m telefone
            const mensalistasComTelefone = mensalistasPendentes.filter(m => m.telefone && m.telefone.replace(/\D/g, '').length >= 11);
            
            if (mensalistasComTelefone.length === 0) {
                alert('‚ùå Nenhum mensalista com telefone v√°lido encontrado!');
                return;
            }
            
            // Mostrar progresso
            let progresso = 0;
            const total = mensalistasComTelefone.length;
            
            const enviarProximo = () => {
                if (progresso < total) {
                    const mensalista = mensalistasComTelefone[progresso];
                    enviarLembreteMensalista(mensalista.id);
                    progresso++;
                    
                    // Atualizar interface
                    const notificacao = document.getElementById('pushNotification');
                    notificacao.style.display = 'block';
                    notificacao.style.background = 'linear-gradient(135deg, rgba(37,211,102,0.9), rgba(18,140,126,0.9))';
                    document.getElementById('pushNotificationTitle').innerHTML = `üì± ENVIANDO NOTIFICA√á√ïES`;
                    document.getElementById('pushNotificationMessage').textContent = `${progresso}/${total} ‚Ä¢ ${mensalista.nome}`;
                    
                    // Pr√≥ximo ap√≥s 3 segundos
                    setTimeout(enviarProximo, 3000);
                } else {
                    // Conclu√≠do
                    const notificacao = document.getElementById('pushNotification');
                    notificacao.style.background = 'linear-gradient(135deg, rgba(37,211,102,0.9), rgba(18,140,126,0.9))';
                    document.getElementById('pushNotificationTitle').innerHTML = `‚úÖ CONCLU√çDO`;
                    document.getElementById('pushNotificationMessage').textContent = `${total} notifica√ß√µes enviadas!`;
                    
                    setTimeout(() => {
                        fecharNotificacao();
                        alert(`‚úÖ ${total} notifica√ß√µes enviadas com sucesso!`);
                    }, 3000);
                }
            };
            
            // Iniciar envio
            enviarProximo();
        }

        // ========== CRUD MENSALISTAS ==========
        function adicionarOuAtualizarMensalista() {
            const nome = document.getElementById('nomeMensalista').value.trim();
            const telefone = document.getElementById('telefoneMensalista').value.trim();
            const barbeiro = document.getElementById('barbeiroMensalista').value;
            const valor = parseFloat(document.getElementById('valorMensalista').value);
            const dataInicio = document.getElementById('dataInicioMensalista').value;
            const diaVencimento = parseInt(document.getElementById('diaVencimentoMensalista').value);
            const status = document.getElementById('statusMensalista').value;
            const observacoes = document.getElementById('observacoesMensalista').value.trim();
            
            if (!nome || !barbeiro || isNaN(valor) || !dataInicio || !diaVencimento) {
                alert('‚ùå Preencha todos os campos obrigat√≥rios!');
                return;
            }
            
            if (editandoMensalistaId) {
                // Atualizar mensalista existente
                atualizarMensalista(editandoMensalistaId, nome, telefone, barbeiro, valor, dataInicio, diaVencimento, status, observacoes);
            } else {
                // Adicionar novo mensalista
                adicionarNovoMensalista(nome, telefone, barbeiro, valor, dataInicio, diaVencimento, status, observacoes);
            }
        }

        function adicionarNovoMensalista(nome, telefone, barbeiro, valor, dataInicio, diaVencimento, status, observacoes) {
            // Gerar ID √∫nico
            const id = dados.mensalistas.length > 0 ? Math.max(...dados.mensalistas.map(m => m.id)) + 1 : 1;
            
            // Calcular data de vencimento
            const dataInicioObj = new Date(dataInicio);
            let dataVencimento = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth(), diaVencimento);
            
            // Se o dia de vencimento for menor que o dia atual, vai para o pr√≥ximo m√™s
            if (dataVencimento < dataInicioObj) {
                dataVencimento = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth() + 1, diaVencimento);
            }
            
            const novoMensalista = {
                id: id,
                nome: nome,
                telefone: telefone,
                barbeiro: barbeiro,
                valor: valor,
                dataInicio: dataInicio,
                diaVencimento: diaVencimento,
                dataVencimento: dataVencimento.toISOString().split('T')[0],
                status: status,
                observacoes: observacoes,
                historicoPagamentos: []
            };
            
            dados.mensalistas.push(novoMensalista);
            salvarDados();
            
            // Limpar formul√°rio
            limparFormMensalista();
            
            // Atualizar interface
            atualizarDashboardCompleto();
            
            // Fechar modal se estiver aberto
            fecharModal('modalMensalistas');
            
            // Mostrar confirma√ß√£o
            alert(`‚úÖ Mensalista "${nome}" cadastrado com sucesso!`);
        }

        function atualizarMensalista(id, nome, telefone, barbeiro, valor, dataInicio, diaVencimento, status, observacoes) {
            const mensalista = dados.mensalistas.find(m => m.id === id);
            if (!mensalista) {
                alert('‚ùå Mensalista n√£o encontrado!');
                return;
            }
            
            // Atualizar dados
            mensalista.nome = nome;
            mensalista.telefone = telefone;
            mensalista.barbeiro = barbeiro;
            mensalista.valor = valor;
            mensalista.dataInicio = dataInicio;
            mensalista.diaVencimento = diaVencimento;
            mensalista.status = status;
            mensalista.observacoes = observacoes;
            
            // Recalcular vencimento se necess√°rio
            if (diaVencimento !== mensalista.diaVencimento || dataInicio !== mensalista.dataInicio) {
                const dataInicioObj = new Date(dataInicio);
                let dataVencimento = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth(), diaVencimento);
                
                if (dataVencimento < dataInicioObj) {
                    dataVencimento = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth() + 1, diaVencimento);
                }
                
                mensalista.dataVencimento = dataVencimento.toISOString().split('T')[0];
            }
            
            salvarDados();
            
            // Resetar modo edi√ß√£o
            editandoMensalistaId = null;
            document.getElementById('btnAdicionarMensalista').textContent = '‚úÖ Cadastrar Mensalista';
            
            // Limpar formul√°rio
            limparFormMensalista();
            
            // Atualizar interface
            atualizarDashboardCompleto();
            
            // Fechar modal
            fecharModal('modalMensalistas');
            
            alert(`‚úÖ Mensalista "${nome}" atualizado com sucesso!`);
        }

        function editarMensalista(id) {
            const mensalista = dados.mensalistas.find(m => m.id === id);
            if (!mensalista) {
                alert('‚ùå Mensalista n√£o encontrado!');
                return;
            }
            
            // Preencher formul√°rio
            document.getElementById('nomeMensalista').value = mensalista.nome;
            document.getElementById('telefoneMensalista').value = mensalista.telefone || '';
            document.getElementById('barbeiroMensalista').value = mensalista.barbeiro;
            document.getElementById('valorMensalista').value = mensalista.valor;
            document.getElementById('dataInicioMensalista').value = mensalista.dataInicio;
            document.getElementById('diaVencimentoMensalista').value = mensalista.diaVencimento;
            document.getElementById('statusMensalista').value = mensalista.status;
            document.getElementById('observacoesMensalista').value = mensalista.observacoes || '';
            
            // Mudar para modo edi√ß√£o
            editandoMensalistaId = id;
            document.getElementById('btnAdicionarMensalista').textContent = 'üíæ Atualizar Mensalista';
            
            // Abrir modal
            abrirModalMensalistas();
        }

        function pagarMensalidade(id) {
            const mensalista = dados.mensalistas.find(m => m.id === id);
            if (!mensalista) {
                alert('‚ùå Mensalista n√£o encontrado!');
                return;
            }
            
            const hoje = new Date();
            const confirmar = confirm(`üíµ Registrar pagamento de R$ ${mensalista.valor.toFixed(2)} para ${mensalista.nome}?`);
            
            if (!confirmar) return;
            
            // Registrar pagamento
            if (!mensalista.historicoPagamentos) {
                mensalista.historicoPagamentos = [];
            }
            
            mensalista.historicoPagamentos.push({
                data: hoje.toISOString().split('T')[0],
                valor: mensalista.valor,
                pagoPor: 'Sistema'
            });
            
            // Atualizar status e calcular pr√≥ximo vencimento
            mensalista.status = 'pago';
            mensalista.dataUltimoPagamento = hoje.toISOString().split('T')[0];
            
            // Calcular pr√≥ximo vencimento
            const dataVencimentoAtual = new Date(mensalista.dataVencimento);
            const proximoVencimento = new Date(dataVencimentoAtual.getFullYear(), dataVencimentoAtual.getMonth() + 1, mensalista.diaVencimento);
            mensalista.dataVencimento = proximoVencimento.toISOString().split('T')[0];
            
            salvarDados();
            
            // Atualizar interface
            atualizarDashboardCompleto();
            
            alert(`‚úÖ Pagamento de R$ ${mensalista.valor.toFixed(2)} registrado para ${mensalista.nome}!`);
        }

        function removerMensalista(id) {
            if (!confirm('‚ö†Ô∏è Tem certeza que deseja remover este mensalista?')) {
                return;
            }
            
            const index = dados.mensalistas.findIndex(m => m.id === id);
            if (index === -1) {
                alert('‚ùå Mensalista n√£o encontrado!');
                return;
            }
            
            const nomeRemovido = dados.mensalistas[index].nome;
            dados.mensalistas.splice(index, 1);
            salvarDados();
            
            // Atualizar interface
            atualizarDashboardCompleto();
            
            alert(`üóëÔ∏è Mensalista "${nomeRemovido}" removido com sucesso!`);
        }

        function enviarLembreteMensalista(id) {
            const mensalista = dados.mensalistas.find(m => m.id === id);
            if (!mensalista) {
                alert('‚ùå Mensalista n√£o encontrado!');
                return;
            }
            
            if (!mensalista.telefone || mensalista.telefone.replace(/\D/g, '').length < 11) {
                alert('‚ùå N√∫mero de telefone inv√°lido para envio de mensagem!');
                return;
            }
            
            const hoje = new Date();
            const dataVencimento = new Date(mensalista.dataVencimento);
            const diasAteVencimento = Math.ceil((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
            
            let mensagem = '';
            if (mensalista.status === 'vencido') {
                mensagem = `*LEMBRETE MENSALIDADE VENCIDA*%0A%0A` +
                          `Ol√° ${mensalista.nome},%0A%0A` +
                          `Sua mensalidade est√° *VENCIDA*!%0A` +
                          `Valor: R$ ${mensalista.valor.toFixed(2)}%0A` +
                          `Vencimento: ${formatarDataBR(mensalista.dataVencimento)}%0A` +
                          `Barbeiro: ${mensalista.barbeiro}%0A%0A` +
                          `*Por favor, regularize o pagamento.*%0A%0A` +
                          `BarbaPRO Duo`;
            } else if (mensalista.status === 'pendente') {
                mensagem = `*LEMBRETE MENSALIDADE*%0A%0A` +
                          `Ol√° ${mensalista.nome},%0A%0A` +
                          `Lembrete da sua mensalidade:%0A` +
                          `Valor: R$ ${mensalista.valor.toFixed(2)}%0A` +
                          `Vencimento: ${formatarDataBR(mensalista.dataVencimento)}%0A` +
                          `Vence em: ${diasAteVencimento} ${diasAteVencimento === 1 ? 'dia' : 'dias'}%0A` +
                          `Barbeiro: ${mensalista.barbeiro}%0A%0A` +
                          `*Obrigado pela prefer√™ncia!*%0A%0A` +
                          `BarbaPRO Duo`;
            } else {
                mensagem = `*CONFIRMA√á√ÉO DE PAGAMENTO*%0A%0A` +
                          `Ol√° ${mensalista.nome},%0A%0A` +
                          `Pagamento confirmado!%0A` +
                          `Valor: R$ ${mensalista.valor.toFixed(2)}%0A` +
                          `Pr√≥ximo vencimento: ${formatarDataBR(mensalista.dataVencimento)}%0A` +
                          `Barbeiro: ${mensalista.barbeiro}%0A%0A` +
                          `*Obrigado pela prefer√™ncia!*%0A%0A` +
                          `BarbaPRO Duo`;
            }
            
            const telefoneFormatado = mensalista.telefone.replace(/\D/g, '');
            const urlWhatsApp = `https://wa.me/55${telefoneFormatado}?text=${mensagem}`;
            
            // Abrir em nova aba
            window.open(urlWhatsApp, '_blank');
        }

        function enviarLembretesMensalistas() {
            const mensalistasPendentes = dados.mensalistas.filter(m => m.status === 'pendente' || m.status === 'vencido');
            
            if (mensalistasPendentes.length === 0) {
                alert('‚úÖ N√£o h√° mensalistas pendentes para enviar lembretes!');
                return;
            }
            
            notificarTodosMensalistas();
        }

        function limparFormMensalista() {
            document.getElementById('nomeMensalista').value = '';
            document.getElementById('telefoneMensalista').value = '';
            document.getElementById('valorMensalista').value = '';
            document.getElementById('observacoesMensalista').value = '';
            
            // Resetar valores padr√£o
            const hoje = new Date();
            document.getElementById('dataInicioMensalista').value = hoje.toISOString().split('T')[0];
            document.getElementById('diaVencimentoMensalista').value = hoje.getDate();
            
            // Resetar modo edi√ß√£o
            editandoMensalistaId = null;
            document.getElementById('btnAdicionarMensalista').textContent = '‚úÖ Cadastrar Mensalista';
        }

        // ========== FUN√á√ïES DE SERVI√áOS ==========
        function atualizarListaServicosRecentes() {
            const dataInicio = document.getElementById('dataInicioServicos').value;
            const dataFim = document.getElementById('dataFimServicos').value;
            const filtroBarbeiro = document.getElementById('filtroBarbeiroServicos').value;
            const filtroPagamento = document.getElementById('filtroPagamentoServicos').value;
            
            let todosServicos = [...dados.Gabriel, ...dados.Wagner];
            
            // Aplicar filtros
            if (dataInicio && dataFim) {
                todosServicos = todosServicos.filter(servico => {
                    // Filtro por data
                    if (servico.data < dataInicio || servico.data > dataFim) return false;
                    
                    // Filtro por barbeiro
                    if (filtroBarbeiro !== 'todos' && servico.barbeiro !== filtroBarbeiro) return false;
                    
                    // Filtro por pagamento
                    if (filtroPagamento === 'pago' && !servico.pago) return false;
                    if (filtroPagamento === 'fiado' && servico.pago) return false;
                    
                    return true;
                });
            }
            
            // Ordenar por data e hora (mais recente primeiro)
            todosServicos.sort((a, b) => {
                const dataA = new Date(a.data + 'T' + (a.hora || '00:00'));
                const dataB = new Date(b.data + 'T' + (b.hora || '00:00'));
                return dataB - dataA;
            });
            
            // Calcular totais filtrados
            const totalFiltrado = todosServicos.reduce((sum, s) => sum + s.valor, 0);
            const totalPagoFiltrado = todosServicos.filter(s => s.pago).reduce((sum, s) => sum + s.valor, 0);
            
            let html = '';
            
            if (todosServicos.length > 0) {
                html = `
                    <div style="background: rgba(255,255,255,0.03); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 12px; color: #aaa;">TOTAL FILTRADO</div>
                                <div style="font-size: 24px; font-weight: 700; color: #ffaa00;">R$ ${totalFiltrado.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #aaa;">SERVI√áOS</div>
                                <div style="font-size: 24px; font-weight: 700; color: #fff;">${todosServicos.length}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: #aaa;">RECEBIDO</div>
                                <div style="font-size: 20px; font-weight: 600; color: #25D366;">R$ ${totalPagoFiltrado.toFixed(2)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>üìÖ Data</th>
                                <th>‚è∞ Hora</th>
                                <th>üë§ Barbeiro</th>
                                <th>‚úÇÔ∏è Servi√ßo</th>
                                <th>üë§ Cliente</th>
                                <th>üí∞ Valor</th>
                                <th>üí≥ Pagamento</th>
                                <th>üìä Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                todosServicos.slice(0, 50).forEach(servico => {
                    const statusClass = servico.pago ? 'status-pago' : 'status-pendente';
                    const statusTexto = servico.pago ? 'PAGO' : 'FIADO';
                    const metodoPagamento = servico.metodoPagamento || 'N/A';
                    
                    let metodoIcon = 'üí∞';
                    switch(metodoPagamento) {
                        case 'dinheiro': metodoIcon = 'üíµ'; break;
                        case 'pix': metodoIcon = 'üì±'; break;
                        case 'debito': metodoIcon = 'üí≥'; break;
                        case 'credito': metodoIcon = 'üí≥'; break;
                    }
                    
                    html += `
                        <tr>
                            <td>${formatarDataBR(servico.data)}</td>
                            <td>${servico.hora}</td>
                            <td>
                                <span class="badge ${servico.barbeiro === 'Gabriel' ? 'badge-warning' : 'badge-success'}">
                                    ${servico.barbeiro}
                                </span>
                            </td>
                            <td>${servico.tipo}</td>
                            <td>${servico.cliente}</td>
                            <td style="font-weight: 600; color: #ffaa00;">R$ ${servico.valor.toFixed(2)}</td>
                            <td>${metodoIcon} ${metodoPagamento.toUpperCase()}</td>
                            <td><span class="status-tag ${statusClass}">${statusTexto}</span></td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    
                    <div style="text-align: center; margin-top: 20px; color: #aaa; font-size: 14px;">
                        Mostrando ${Math.min(todosServicos.length, 50)} de ${todosServicos.length} servi√ßos
                        ${todosServicos.length > 50 ? '(use filtros para ver mais)' : ''}
                    </div>
                `;
            } else {
                html = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div class="empty-state-title">Nenhum servi√ßo encontrado</div>
                        <div class="empty-state-subtitle">
                            Tente ajustar os filtros ou datas
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('listaServicosRecentes').innerHTML = html;
        }

        function exportarDadosServicos() {
            const dataInicio = document.getElementById('dataInicioServicos').value;
            const dataFim = document.getElementById('dataFimServicos').value;
            const filtroBarbeiro = document.getElementById('filtroBarbeiroServicos').value;
            const filtroPagamento = document.getElementById('filtroPagamentoServicos').value;
            
            let servicos = [...dados.Gabriel, ...dados.Wagner].filter(s => {
                if (s.data < dataInicio || s.data > dataFim) return false;
                if (filtroBarbeiro !== 'todos' && s.barbeiro !== filtroBarbeiro) return false;
                if (filtroPagamento === 'pago' && !s.pago) return false;
                if (filtroPagamento === 'fiado' && s.pago) return false;
                return true;
            });
            
            // Converter para CSV
            let csv = 'Data,Hora,Barbeiro,Cliente,Servi√ßo,Valor,Status Pagamento,M√©todo Pagamento,Observa√ß√µes\n';
            
            servicos.forEach(s => {
                const linha = [
                    s.data,
                    s.hora,
                    s.barbeiro,
                    s.cliente,
                    s.tipo,
                    s.valor.toFixed(2),
                    s.pago ? 'PAGO' : 'FIADO',
                    s.metodoPagamento || 'N/A',
                    s.observacoes || ''
                ].map(campo => `"${campo}"`).join(',');
                
                csv += linha + '\n';
            });
            
            // Criar arquivo e baixar
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `servicos_${dataInicio}_a_${dataFim}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`üì• Arquivo CSV gerado com ${servicos.length} servi√ßos!`);
        }

        // ========== MODAIS ==========
        function abrirModalResumoCompleto() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            // Calcular totais Gabriel
            const servicosGabrielMes = dados.Gabriel.filter(s => {
                const dataServico = new Date(s.data);
                return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
            });
            
            const totalGabriel = servicosGabrielMes.reduce((sum, s) => sum + s.valor, 0);
            const fiadoGabriel = servicosGabrielMes.filter(s => !s.pago).reduce((sum, s) => sum + s.valor, 0);
            const pagoGabriel = totalGabriel - fiadoGabriel;
            const mediaGabriel = servicosGabrielMes.length > 0 ? (totalGabriel / servicosGabrielMes.length) : 0;
            
            // Calcular totais Wagner
            const servicosWagnerMes = dados.Wagner.filter(s => {
                const dataServico = new Date(s.data);
                return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
            });
            
            const totalWagner = servicosWagnerMes.reduce((sum, s) => sum + s.valor, 0);
            const fiadoWagner = servicosWagnerMes.filter(s => !s.pago).reduce((sum, s) => sum + s.valor, 0);
            const pagoWagner = totalWagner - fiadoWagner;
            const mediaWagner = servicosWagnerMes.length > 0 ? (totalWagner / servicosWagnerMes.length) : 0;
            
            // Totais gerais
            const totalMes = totalGabriel + totalWagner;
            const totalFiado = fiadoGabriel + fiadoWagner;
            const totalPago = pagoGabriel + pagoWagner;
            const totalServicos = servicosGabrielMes.length + servicosWagnerMes.length;
            
            const html = `
                <div style="background: linear-gradient(135deg, rgba(255,170,0,0.1), rgba(51,102,255,0.1)); border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 24px; font-weight: 800; color: #ffaa00;">üìä RESUMO DO M√äS</div>
                        <div style="color: #aaa; font-size: 14px;">${hoje.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'}).toUpperCase()}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #aaa;">TOTAL GABRIEL</div>
                            <div style="font-size: 32px; font-weight: 800; color: #ffaa00; margin: 10px 0;">R$ ${totalGabriel.toFixed(2)}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px;">
                                <div>
                                    <div style="color: #25D366;">‚úÖ R$ ${pagoGabriel.toFixed(2)}</div>
                                    <div>Recebido</div>
                                </div>
                                <div>
                                    <div style="color: #FF9500;">‚è≥ R$ ${fiadoGabriel.toFixed(2)}</div>
                                    <div>Fiado</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #aaa;">TOTAL WAGNER</div>
                            <div style="font-size: 32px; font-weight: 800; color: #3366ff; margin: 10px 0;">R$ ${totalWagner.toFixed(2)}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px;">
                                <div>
                                    <div style="color: #25D366;">‚úÖ R$ ${pagoWagner.toFixed(2)}</div>
                                    <div>Recebido</div>
                                </div>
                                <div>
                                    <div style="color: #FF9500;">‚è≥ R$ ${fiadoWagner.toFixed(2)}</div>
                                    <div>Fiado</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 12px; color: #aaa;">TOTAL GERAL</div>
                            <div style="font-size: 18px; font-weight: 700; color: #25D366;">R$ ${totalMes.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #aaa;">SERVI√áOS</div>
                            <div style="font-size: 18px; font-weight: 700; color: #fff;">${totalServicos}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #aaa;">M√âDIA/SERVI√áO</div>
                            <div style="font-size: 18px; font-weight: 700; color: #ffaa00;">R$ ${(totalMes / totalServicos || 0).toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #aaa;">% FIADO</div>
                            <div style="font-size: 18px; font-weight: 700; color: ${totalFiado > totalMes * 0.3 ? '#ff3366' : '#FF9500'};">${totalMes > 0 ? ((totalFiado / totalMes) * 100).toFixed(1) : '0'}%</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('conteudoResumo').innerHTML = html;
            document.getElementById('modalResumo').style.display = 'flex';
        }

        function abrirModalPagamentos() {
            document.getElementById('modalPagamentos').style.display = 'flex';
            gerarRelatorioPagamentosDetalhado();
        }

        function gerarRelatorioPagamentosDetalhado() {
            const dataInicio = document.getElementById('dataInicioPagamentos').value;
            const dataFim = document.getElementById('dataFimPagamentos').value;
            const filtroBarbeiro = document.getElementById('filtroBarbeiroPagamentos').value;
            
            // Coletar servi√ßos no per√≠odo
            let todosServicos = [...dados.Gabriel, ...dados.Wagner].filter(s => {
                return s.data >= dataInicio && s.data <= dataFim;
            });
            
            if (filtroBarbeiro !== 'todos') {
                todosServicos = todosServicos.filter(s => s.barbeiro === filtroBarbeiro);
            }
            
            // Calcular totais
            const totalPeriodo = todosServicos.reduce((sum, s) => sum + s.valor, 0);
            const totalPago = todosServicos.filter(s => s.pago).reduce((sum, s) => sum + s.valor, 0);
            const totalFiado = totalPeriodo - totalPago;
            
            // Gerar HTML
            let html = `
                <div style="background: linear-gradient(135deg, rgba(255,170,0,0.1), rgba(51,102,255,0.1)); border-radius: 15px; padding: 25px; margin-bottom: 25px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 20px; font-weight: 800; color: #ffaa00;">üí∞ RELAT√ìRIO DE PAGAMENTOS</div>
                        <div style="color: #aaa; font-size: 14px;">${formatarDataBR(dataInicio)} √† ${formatarDataBR(dataFim)}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 12px; color: #aaa;">TOTAL PER√çODO</div>
                            <div style="font-size: 24px; font-weight: 800; color: #25D366;">R$ ${totalPeriodo.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #aaa;">SERVI√áOS</div>
                            <div style="font-size: 24px; font-weight: 800; color: #fff;">${todosServicos.length}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #aaa;">RECEBIDO</div>
                            <div style="font-size: 20px; font-weight: 700; color: #25D366;">R$ ${totalPago.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #aaa;">FIADO</div>
                            <div style="font-size: 20px; font-weight: 700; color: #FF9500;">R$ ${totalFiado.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('relatorioPagamentosDetalhado').innerHTML = html;
        }

        function abrirModalMensalistas() {
            document.getElementById('modalMensalistas').style.display = 'flex';
        }

        function abrirModalConfiguracoes() {
            // Preencher valores atuais
            document.getElementById('numWhats').value = dados.config.whatsapp || '';
            document.getElementById('novoPin').value = '';
            document.getElementById('valCorte').value = dados.config.corte || 28;
            document.getElementById('valBarba').value = dados.config.barba || 15;
            document.getElementById('valCombo').value = dados.config.combo || 40;
            document.getElementById('notificacoesAtivas').value = dados.config.notificacoesAtivas ? 'true' : 'false';
            document.getElementById('diasAlerta').value = dados.config.diasAlerta || 3;
            
            document.getElementById('modalConfig').style.display = 'flex';
        }

        function salvarConfiguracoes() {
            const whatsapp = document.getElementById('numWhats').value.trim();
            const novoPin = document.getElementById('novoPin').value.trim();
            const corte = parseFloat(document.getElementById('valCorte').value);
            const barba = parseFloat(document.getElementById('valBarba').value);
            const combo = parseFloat(document.getElementById('valCombo').value);
            const notificacoesAtivas = document.getElementById('notificacoesAtivas').value === 'true';
            const diasAlerta = parseInt(document.getElementById('diasAlerta').value);
            
            // Validar valores
            if (whatsapp && !/^\d{10,15}$/.test(whatsapp.replace(/\D/g, ''))) {
                alert('‚ùå N√∫mero de WhatsApp inv√°lido!');
                return;
            }
            
            if (novoPin && !/^\d{4}$/.test(novoPin)) {
                alert('‚ùå PIN deve conter 4 d√≠gitos!');
                return;
            }
            
            if (isNaN(corte) || isNaN(barba) || isNaN(combo) || isNaN(diasAlerta)) {
                alert('‚ùå Valores inv√°lidos!');
                return;
            }
            
            // Atualizar configura√ß√µes
            if (whatsapp) dados.config.whatsapp = whatsapp;
            if (novoPin) dados.config.pin = novoPin;
            dados.config.corte = corte;
            dados.config.barba = barba;
            dados.config.combo = combo;
            dados.config.notificacoesAtivas = notificacoesAtivas;
            dados.config.diasAlerta = diasAlerta;
            
            salvarDados();
            
            // Fechar modal
            fecharModal('modalConfig');
            
            alert('‚úÖ Configura√ß√µes salvas com sucesso!');
        }

        function enviarRelatorioWhatsApp(tipo) {
            const numero = dados.config.whatsapp || '11974065186';
            
            if (!numero || numero.length < 10) {
                alert('‚ùå Configure um n√∫mero de WhatsApp nas configura√ß√µes!');
                abrirModalConfiguracoes();
                return;
            }
            
            let mensagem = '';
            const hoje = new Date();
            
            switch(tipo) {
                case 'resumo':
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    
                    const servicosGabriel = dados.Gabriel.filter(s => {
                        const data = new Date(s.data);
                        return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
                    });
                    const servicosWagner = dados.Wagner.filter(s => {
                        const data = new Date(s.data);
                        return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
                    });
                    
                    const totalGabriel = servicosGabriel.reduce((s, v) => s + v.valor, 0);
                    const totalWagner = servicosWagner.reduce((s, v) => s + v.valor, 0);
                    const totalMes = totalGabriel + totalWagner;
                    const totalServicos = servicosGabriel.length + servicosWagner.length;
                    
                    mensagem = `*üìä RESUMO MENSAL BARBAPRO DUO*%0A%0A` +
                              `Per√≠odo: ${hoje.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})}%0A%0A` +
                              `*GABRIEL:*%0A` +
                              `Servi√ßos: ${servicosGabriel.length}%0A` +
                              `Total: R$ ${totalGabriel.toFixed(2)}%0A%0A` +
                              `*WAGNER:*%0A` +
                              `Servi√ßos: ${servicosWagner.length}%0A` +
                              `Total: R$ ${totalWagner.toFixed(2)}%0A%0A` +
                              `*TOTAL GERAL:*%0A` +
                              `Servi√ßos: ${totalServicos}%0A` +
                              `Faturamento: R$ ${totalMes.toFixed(2)}%0A%0A` +
                              `*BarbaPRO Duo*`;
                    break;
                    
                case 'servicos':
                    const dataInicio = document.getElementById('dataInicioServicos').value;
                    const dataFim = document.getElementById('dataFimServicos').value;
                    
                    const servicosFiltrados = [...dados.Gabriel, ...dados.Wagner].filter(s => 
                        s.data >= dataInicio && s.data <= dataFim
                    );
                    
                    const total = servicosFiltrados.reduce((s, v) => s + v.valor, 0);
                    const pago = servicosFiltrados.filter(s => s.pago).reduce((s, v) => s + v.valor, 0);
                    
                    mensagem = `*üìù RELAT√ìRIO DE SERVI√áOS*%0A%0A` +
                              `Per√≠odo: ${formatarDataBR(dataInicio)} √† ${formatarDataBR(dataFim)}%0A` +
                              `Servi√ßos: ${servicosFiltrados.length}%0A` +
                              `Total: R$ ${total.toFixed(2)}%0A` +
                              `Recebido: R$ ${pago.toFixed(2)}%0A` +
                              `Fiado: R$ ${(total - pago).toFixed(2)}%0A%0A` +
                              `*BarbaPRO Duo*`;
                    break;
            }
            
            const url = `https://wa.me/55${numero.replace(/\D/g, '')}?text=${mensagem}`;
            window.open(url, '_blank');
        }

        // ========== FUN√á√ïES AUXILIARES ==========
        function formatarDataBR(dataString) {
            if (!dataString) return '';
            const date = new Date(dataString);
            return date.toLocaleDateString('pt-BR');
        }

        function calcularProximoVencimento(dataVencimento) {
            const data = new Date(dataVencimento);
            data.setMonth(data.getMonth() + 1);
            return data.toISOString().split('T')[0];
        }

        function filtrarPorMetodo(metodo) {
            filtroMetodoAtual = filtroMetodoAtual === metodo ? null : metodo;
            atualizarListaServicosRecentes();
        }

        function voltarParaRegistro() {
            // Simulando volta para p√°gina de registro
            alert('Voltando para p√°gina de registro...');
            // Em um sistema real, voc√™ redirecionaria para a p√°gina de registro
            // window.location.href = 'registro.html';
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Inicializar quando carregado
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Dashboard inicializado com sucesso!');
            inicializarDashboard();
        });

        // Sincronizar quando voltar online
        window.addEventListener('online', () => {
            console.log('üåê Conex√£o restaurada');
            // Em um sistema real, voc√™ sincronizaria com o servidor aqui
        });
    </script>
</body>
</html>