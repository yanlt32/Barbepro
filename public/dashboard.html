<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BarbaPRO Duo - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="dash.css">
    <style>
        /* ESTILOS ADICIONAIS PARA DESPESAS */
        .despesa-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #ff3366;
            transition: all 0.3s ease;
        }
        
        .despesa-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }
        
        .despesa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .despesa-categoria {
            background: rgba(255, 51, 102, 0.2);
            color: #ff99bb;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .despesa-valor {
            font-size: 24px;
            font-weight: 700;
            color: #ff3366;
            text-align: right;
        }
        
        .despesa-detalhes {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 13px;
            color: #aaa;
        }
        
        .despesa-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        
        .categoria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .categoria-total {
            font-weight: 700;
            color: #ff3366;
        }
        
        .progresso-despesa {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progresso-bar {
            height: 100%;
            background: linear-gradient(90deg, #ff3366, #ff6699);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Moderno -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">ğŸ’ˆ</div>
                <div>
                    <h1>BarbaPRO Duo</h1>
                    <div class="logo-subtitle">Dashboard Profissional</div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-primary" id="btnVoltarRegistro">
                    â† Voltar ao Registro
                </button>
                <button class="btn btn-whatsapp" id="btnEnviarResumo">
                    ğŸ“± Resumo WhatsApp
                </button>
                <button class="btn btn-secondary" id="btnConfiguracoes">
                    âš™ï¸ ConfiguraÃ§Ãµes
                </button>
            </div>
        </header>

        <!-- NotificaÃ§Ã£o Push -->
        <div class="push-notification" id="pushNotification">
            <div class="push-header">
                <div class="push-title" id="pushNotificationTitle">âš ï¸ ALERTA DE VENCIMENTO</div>
                <button class="push-close" onclick="fecharNotificacao()">Ã—</button>
            </div>
            <div id="pushNotificationMessage">Mensalistas vencidos detectados!</div>
        </div>

        <!-- Alertas Sonoros (simulado) -->
        <audio id="alertSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Card: EstatÃ­sticas Gabriel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ‘¨â€ğŸ¦± GABRIEL</div>
                    <div class="badge badge-success">HOJE</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="gabrielHoje">0</div>
                        <div class="stat-label">ServiÃ§os Hoje</div>
                    </div>
                    <div class="stat-item stat-secondary">
                        <div class="stat-value" id="gabrielTotalHoje">R$ 0</div>
                        <div class="stat-label">Total Hoje</div>
                    </div>
                    <div class="stat-item stat-warning">
                        <div class="stat-value" id="gabrielFiadoHoje">R$ 0</div>
                        <div class="stat-label">Fiado Hoje</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gabrielMedia">R$ 0</div>
                        <div class="stat-label">MÃ©dia/ServiÃ§o</div>
                    </div>
                </div>
            </div>

            <!-- Card: EstatÃ­sticas Wagner -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ‘¨â€ğŸ¦± WAGNER</div>
                    <div class="badge badge-success">HOJE</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="wagnerHoje">0</div>
                        <div class="stat-label">ServiÃ§os Hoje</div>
                    </div>
                    <div class="stat-item stat-secondary">
                        <div class="stat-value" id="wagnerTotalHoje">R$ 0</div>
                        <div class="stat-label">Total Hoje</div>
                    </div>
                    <div class="stat-item stat-warning">
                        <div class="stat-value" id="wagnerFiadoHoje">R$ 0</div>
                        <div class="stat-label">Fiado Hoje</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="wagnerMedia">R$ 0</div>
                        <div class="stat-label">MÃ©dia/ServiÃ§o</div>
                    </div>
                </div>
            </div>

            <!-- Card: EstatÃ­sticas Gerais -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ“Š ESTATÃSTICAS GERAIS</div>
                    <div class="badge badge-warning">MÃŠS ATUAL</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalMes">R$ 0</div>
                        <div class="stat-label">Total MÃªs</div>
                    </div>
                    <div class="stat-item stat-secondary">
                        <div class="stat-value" id="servicosMes">0</div>
                        <div class="stat-label">ServiÃ§os MÃªs</div>
                    </div>
                    <div class="stat-item stat-warning">
                        <div class="stat-value" id="fiadoMes">R$ 0</div>
                        <div class="stat-label">Fiado Total</div>
                    </div>
                    <div class="stat-item stat-danger">
                        <div class="stat-value" id="despesasMes">R$ 0</div>
                        <div class="stat-label">Despesas MÃªs</div>
                    </div>
                </div>
            </div>

            <!-- Card: Controle de Despesas -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ’¸ CONTROLE DE DESPESAS</div>
                    <div class="badge badge-danger">MÃŠS ATUAL</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item" onclick="abrirModalDespesas()">
                        <div class="stat-value" id="totalDespesasMes">R$ 0</div>
                        <div class="stat-label">Total Despesas</div>
                    </div>
                    <div class="stat-item stat-secondary">
                        <div class="stat-value" id="numDespesasMes">0</div>
                        <div class="stat-label">Qtd Despesas</div>
                    </div>
                    <div class="stat-item stat-warning">
                        <div class="stat-value" id="maiorDespesaMes">R$ 0</div>
                        <div class="stat-label">Maior Despesa</div>
                    </div>
                    <div class="stat-item" onclick="abrirModalDespesas()">
                        <div class="stat-value" id="lucroLiquido">R$ 0</div>
                        <div class="stat-label">Lucro LÃ­quido</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-danger" id="btnNovaDespesa" style="width: 100%;">
                        + Nova Despesa
                    </button>
                </div>
            </div>
        </div>

        <!-- Segunda Linha: Pagamentos e MÃ©todos -->
        <div class="dashboard-grid">
            <!-- Card: Resumo Pagamentos Hoje -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ’° PAGAMENTOS - HOJE</div>
                    <div class="badge badge-success">RESUMO</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-item" onclick="filtrarPorMetodo('dinheiro')">
                        <div class="stat-value" id="totalDinheiro">R$ 0</div>
                        <div class="stat-label">ğŸ’µ DINHEIRO</div>
                    </div>
                    <div class="stat-item" onclick="filtrarPorMetodo('pix')">
                        <div class="stat-value" id="totalPix">R$ 0</div>
                        <div class="stat-label">ğŸ“± PIX</div>
                    </div>
                    <div class="stat-item" onclick="filtrarPorMetodo('debito')">
                        <div class="stat-value" id="totalDebito">R$ 0</div>
                        <div class="stat-label">ğŸ’³ DÃ‰BITO</div>
                    </div>
                    <div class="stat-item" onclick="filtrarPorMetodo('credito')">
                        <div class="stat-value" id="totalCredito">R$ 0</div>
                        <div class="stat-label">ğŸ’³ CRÃ‰DITO</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="btn btn-whatsapp" id="btnEnviarPagamentos" style="width: 100%;">
                        ğŸ“± Enviar RelatÃ³rio
                    </button>
                </div>
            </div>

            <!-- Card: GrÃ¡fico DistribuiÃ§Ã£o -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ“ˆ DISTRIBUIÃ‡ÃƒO - HOJE</div>
                    <div class="badge badge-warning">GRÃFICO</div>
                </div>
                <div class="grafico-container">
                    <canvas id="graficoPizza"></canvas>
                </div>
            </div>

            <!-- Card: AÃ§Ãµes RÃ¡pidas -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">âš¡ AÃ‡Ã•ES RÃPIDAS</div>
                    <div class="badge badge-success">MENU</div>
                </div>
                <div style="display: grid; gap: 15px; padding: 10px;">
                    <button class="btn btn-primary" id="btnVerResumoCompleto">
                        ğŸ“Š Ver Resumo Completo
                    </button>
                    <button class="btn btn-success" id="btnRelatorioDetalhado">
                        ğŸ“„ RelatÃ³rio Detalhado
                    </button>
                    <button class="btn btn-whatsapp" id="btnEnviarMensalistas">
                        ğŸ‘¥ Enviar Lembretes
                    </button>
                    <button class="btn btn-danger" id="btnGerenciarDespesas">
                        ğŸ’¸ Gerenciar Despesas
                    </button>
                </div>
            </div>
        </div>

        <!-- Terceira Linha: Mensalistas - ÃREA MELHORADA -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸ‘¥ MENSALISTAS - GERENCIAMENTO INTELIGENTE</div>
                <div>
                    <button class="btn btn-success" id="btnNovoMensalista" style="margin-right: 10px;">
                        + Novo Mensalista
                    </button>
                    <button class="btn btn-whatsapp" id="btnNotificarTodos" onclick="notificarTodosMensalistas()">
                        ğŸ”” Notificar Todos
                    </button>
                </div>
            </div>
            
            <!-- Resumo de Status -->
            <div class="status-resumo" id="resumoStatusMensalistas">
                <!-- DinÃ¢mico -->
            </div>
            
            <!-- Filtros RÃ¡pidos -->
            <div class="status-menu">
                <button class="status-btn active" onclick="filtrarMensalistasPorStatus('todos')">
                    ğŸ“‹ Todos
                    <span class="status-counter" id="counterTodos">0</span>
                </button>
                <button class="status-btn" onclick="filtrarMensalistasPorStatus('pago')">
                    âœ… Pagos
                    <span class="status-counter" id="counterPagos">0</span>
                </button>
                <button class="status-btn" onclick="filtrarMensalistasPorStatus('pendente')">
                    â³ Pendentes
                    <span class="status-counter" id="counterPendentes">0</span>
                </button>
                <button class="status-btn" onclick="filtrarMensalistasPorStatus('vencido')">
                    âš ï¸ Vencidos
                    <span class="status-counter" id="counterVencidos">0</span>
                </button>
                <button class="status-btn" onclick="filtrarMensalistasPorStatus('hoje')">
                    ğŸ“… Vence Hoje
                    <span class="status-counter" id="counterHoje">0</span>
                </button>
            </div>
            
            <!-- Filtros AvanÃ§ados -->
            <div class="filtro-container">
                <div class="filtro-grid">
                    <div class="input-group">
                        <label>ğŸ“… Data InÃ­cio</label>
                        <input type="date" id="dataInicioMensalistas">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“… Data Fim</label>
                        <input type="date" id="dataFimMensalistas">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“Š Status</label>
                        <select id="filtroStatusMensalistas">
                            <option value="todos">ğŸ“‹ Todos os Status</option>
                            <option value="pago">âœ… Pagos</option>
                            <option value="pendente">â³ Pendentes</option>
                            <option value="vencido">âš ï¸ Vencidos</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ğŸ‘¤ Barbeiro</label>
                        <select id="filtroBarbeiroMensalistas">
                            <option value="todos">ğŸ‘¥ Todos Barbeiros</option>
                            <option value="Gabriel">ğŸ‘¨â€ğŸ¦± Gabriel</option>
                            <option value="Wagner">ğŸ‘¨â€ğŸ¦± Wagner</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn btn-primary" id="btnFiltrarMensalistas" style="flex: 1;">
                            ğŸ” Aplicar Filtros
                        </button>
                        <button class="btn btn-secondary" id="btnLimparFiltros" style="flex: 1;">
                            ğŸ—‘ï¸ Limpar Filtros
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Alertas de Vencimento -->
            <div id="alertasVencimento">
                <!-- DinÃ¢mico -->
            </div>
            
            <!-- Lista de Mensalistas -->
            <div id="listaMensalistasDashboard">
                <!-- ConteÃºdo dinÃ¢mico -->
            </div>
        </div>

        <!-- Quarta Linha: Despesas Recentes -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸ’¸ DESPESAS RECENTES</div>
                <button class="btn btn-secondary" id="btnExportarDespesas">
                    ğŸ“¤ Exportar Dados
                </button>
            </div>
            
            <!-- Filtros Despesas -->
            <div class="filtro-container">
                <div class="filtro-grid">
                    <div class="input-group">
                        <label>ğŸ“… Data InÃ­cio</label>
                        <input type="date" id="dataInicioDespesas">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“… Data Fim</label>
                        <input type="date" id="dataFimDespesas">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“Š Categoria</label>
                        <select id="filtroCategoriaDespesas">
                            <option value="todos">ğŸ“‹ Todas Categorias</option>
                            <option value="Suprimentos">ğŸ›’ Suprimentos</option>
                            <option value="Aluguel">ğŸ¢ Aluguel</option>
                            <option value="Energia">ğŸ’¡ Energia</option>
                            <option value="Ãgua">ğŸš° Ãgua</option>
                            <option value="Internet">ğŸŒ Internet</option>
                            <option value="ManutenÃ§Ã£o">ğŸ”§ ManutenÃ§Ã£o</option>
                            <option value="Outros">ğŸ“¦ Outros</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn btn-primary" id="btnFiltrarDespesas" style="flex: 1;">
                            ğŸ” Filtrar Despesas
                        </button>
                        <button class="btn btn-danger" id="btnNovaDespesaRapida" style="flex: 1;">
                            + Nova Despesa
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Despesas -->
            <div id="listaDespesasRecentes">
                <!-- ConteÃºdo dinÃ¢mico -->
            </div>
        </div>

        <!-- Quinta Linha: ServiÃ§os Recentes -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸ“ SERVIÃ‡OS RECENTES</div>
                <button class="btn btn-secondary" id="btnExportarServicos">
                    ğŸ“¤ Exportar Dados
                </button>
            </div>
            
            <!-- Filtros ServiÃ§os -->
            <div class="filtro-container">
                <div class="filtro-grid">
                    <div class="input-group">
                        <label>ğŸ“… Data InÃ­cio</label>
                        <input type="date" id="dataInicioServicos">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“… Data Fim</label>
                        <input type="date" id="dataFimServicos">
                    </div>
                    <div class="input-group">
                        <label>ğŸ‘¤ Barbeiro</label>
                        <select id="filtroBarbeiroServicos">
                            <option value="todos">ğŸ‘¥ Todos Barbeiros</option>
                            <option value="Gabriel">ğŸ‘¨â€ğŸ¦± Gabriel</option>
                            <option value="Wagner">ğŸ‘¨â€ğŸ¦± Wagner</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>ğŸ’° Status Pagamento</label>
                        <select id="filtroPagamentoServicos">
                            <option value="todos">ğŸ“‹ Todos</option>
                            <option value="pago">âœ… Pagos</option>
                            <option value="fiado">â³ Fiados</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn btn-primary" id="btnFiltrarServicos" style="flex: 1;">
                            ğŸ” Filtrar ServiÃ§os
                        </button>
                        <button class="btn btn-whatsapp" id="btnEnviarRelatorioServicos" style="flex: 1;">
                            ğŸ“± Enviar RelatÃ³rio
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tabela de ServiÃ§os -->
            <div class="table-container">
                <div id="listaServicosRecentes">
                    <!-- ConteÃºdo dinÃ¢mico -->
                </div>
            </div>
        </div>
    </div>

    <!-- ========== MODAIS ========== -->

    <!-- Modal: Resumo Completo -->
    <div class="modal" id="modalResumo">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“Š RESUMO COMPLETO - BARBEIROS</h2>
                <button class="close-btn" data-modal="modalResumo">&times;</button>
            </div>
            <div id="conteudoResumo">
                <!-- DinÃ¢mico -->
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" data-modal="modalResumo">
                    Fechar
                </button>
                <button class="btn btn-whatsapp" id="btnEnviarResumoCompleto">
                    ğŸ“± Enviar por WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: RelatÃ³rio Pagamentos -->
    <div class="modal" id="modalPagamentos">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ’° RELATÃ“RIO DE PAGAMENTOS DETALHADO</h2>
                <button class="close-btn" data-modal="modalPagamentos">&times;</button>
            </div>
            <div class="filtro-container">
                <div class="filtro-grid">
                    <div class="input-group">
                        <label>ğŸ“… Data InÃ­cio</label>
                        <input type="date" id="dataInicioPagamentos">
                    </div>
                    <div class="input-group">
                        <label>ğŸ“… Data Fim</label>
                        <input type="date" id="dataFimPagamentos">
                    </div>
                    <div class="input-group">
                        <label>ğŸ‘¤ Barbeiro</label>
                        <select id="filtroBarbeiroPagamentos">
                            <option value="todos">ğŸ‘¥ Todos Barbeiros</option>
                            <option value="Gabriel">ğŸ‘¨â€ğŸ¦± Gabriel</option>
                            <option value="Wagner">ğŸ‘¨â€ğŸ¦± Wagner</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn btn-primary" id="btnGerarRelatorio" style="flex: 1;">
                            ğŸ“ˆ Gerar RelatÃ³rio
                        </button>
                        <button class="btn btn-whatsapp" id="btnEnviarRelatorioWhatsApp" style="flex: 1;">
                            ğŸ“± Enviar WhatsApp
                        </button>
                    </div>
                </div>
            </div>
            <div id="relatorioPagamentosDetalhado">
                <!-- ConteÃºdo dinÃ¢mico -->
            </div>
        </div>
    </div>

    <!-- Modal: Mensalistas Detalhado -->
    <div class="modal" id="modalMensalistas">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ‘¥ GERENCIAMENTO DE MENSALISTAS</h2>
                <button class="close-btn" data-modal="modalMensalistas">&times;</button>
            </div>
            
            <!-- FormulÃ¡rio Novo Mensalista -->
            <div class="card" style="margin-bottom: 25px;">
                <div class="card-header">
                    <div class="card-title">â• NOVO MENSALISTA</div>
                    <div class="badge badge-success">CADASTRO</div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ğŸ‘¤ Nome do Cliente *</label>
                        <input type="text" id="nomeMensalista" placeholder="Nome completo do cliente">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“± Telefone (WhatsApp)</label>
                        <input type="tel" id="telefoneMensalista" placeholder="(11) 99999-9999" maxlength="15">
                    </div>
                    <div class="form-group">
                        <label>ğŸ‘¨â€ğŸ¦± Barbeiro *</label>
                        <select id="barbeiroMensalista">
                            <option value="Gabriel">Gabriel</option>
                            <option value="Wagner">Wagner</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ’° Valor Mensal (R$) *</label>
                        <input type="number" step="0.01" id="valorMensalista" placeholder="120.00">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… Data de InÃ­cio *</label>
                        <input type="date" id="dataInicioMensalista">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… Dia de Vencimento (1-31) *</label>
                        <input type="number" min="1" max="31" id="diaVencimentoMensalista" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“Š Status *</label>
                        <select id="statusMensalista">
                            <option value="pago">âœ… Pago</option>
                            <option value="pendente">â³ Pendente</option>
                            <option value="vencido">âš ï¸ Vencido</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ ObservaÃ§Ãµes</label>
                        <textarea id="observacoesMensalista" rows="2" placeholder="ObservaÃ§Ãµes importantes..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="btnLimparFormMensalista">
                        Limpar FormulÃ¡rio
                    </button>
                    <button class="btn btn-success" id="btnAdicionarMensalista">
                        âœ… Cadastrar Mensalista
                    </button>
                </div>
            </div>
            
            <!-- Lista de Mensalistas -->
            <div id="listaMensalistasModal">
                <!-- DinÃ¢mico -->
            </div>
        </div>
    </div>

    <!-- Modal: Gerenciamento de Despesas -->
    <div class="modal" id="modalDespesas">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ğŸ’¸ GERENCIAMENTO DE DESPESAS</h2>
                <button class="close-btn" data-modal="modalDespesas">&times;</button>
            </div>
            
            <!-- FormulÃ¡rio Nova Despesa -->
            <div class="card" style="margin-bottom: 25px;">
                <div class="card-header">
                    <div class="card-title">â• NOVA DESPESA</div>
                    <div class="badge badge-danger">REGISTRO</div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label>ğŸ“ DescriÃ§Ã£o *</label>
                        <input type="text" id="descricaoDespesa" placeholder="Ex: Compra de produtos, Pagamento de conta...">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“Š Categoria *</label>
                        <select id="categoriaDespesa">
                            <option value="Suprimentos">ğŸ›’ Suprimentos</option>
                            <option value="Aluguel">ğŸ¢ Aluguel</option>
                            <option value="Energia">ğŸ’¡ Energia</option>
                            <option value="Ãgua">ğŸš° Ãgua</option>
                            <option value="Internet">ğŸŒ Internet</option>
                            <option value="ManutenÃ§Ã£o">ğŸ”§ ManutenÃ§Ã£o</option>
                            <option value="SalÃ¡rios">ğŸ’¼ SalÃ¡rios</option>
                            <option value="Marketing">ğŸ“¢ Marketing</option>
                            <option value="Outros">ğŸ“¦ Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ’° Valor (R$) *</label>
                        <input type="number" step="0.01" id="valorDespesa" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“… Data *</label>
                        <input type="date" id="dataDespesa">
                    </div>
                    <div class="form-group">
                        <label>ğŸ·ï¸ Tags (separadas por vÃ­rgula)</label>
                        <input type="text" id="tagsDespesa" placeholder="urgente, mensal, variÃ¡vel">
                    </div>
                    <div class="form-group">
                        <label>ğŸ§¾ Comprovante (opcional)</label>
                        <input type="text" id="comprovanteDespesa" placeholder="NÃºmero ou descriÃ§Ã£o do comprovante">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“ ObservaÃ§Ãµes</label>
                        <textarea id="observacoesDespesa" rows="2" placeholder="Detalhes adicionais..."></textarea>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" id="btnLimparFormDespesa">
                        Limpar FormulÃ¡rio
                    </button>
                    <button class="btn btn-danger" id="btnAdicionarDespesa">
                        ğŸ’¾ Registrar Despesa
                    </button>
                </div>
            </div>
            
            <!-- Resumo de Despesas -->
            <div class="card" style="margin-bottom: 25px;">
                <div class="card-header">
                    <div class="card-title">ğŸ“ˆ RESUMO FINANCEIRO</div>
                    <div class="badge badge-warning">MÃŠS ATUAL</div>
                </div>
                <div id="resumoFinanceiroDespesas">
                    <!-- DinÃ¢mico -->
                </div>
            </div>
            
            <!-- Lista de Despesas -->
            <div id="listaDespesasModal">
                <!-- DinÃ¢mico -->
            </div>
        </div>
    </div>

    <!-- Modal: ConfiguraÃ§Ãµes -->
    <div class="modal" id="modalConfig">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">âš™ï¸ CONFIGURAÃ‡Ã•ES DO SISTEMA</h2>
                <button class="close-btn" data-modal="modalConfig">&times;</button>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>ğŸ“± NÃºmero WhatsApp RelatÃ³rios</label>
                    <input type="tel" id="numWhats" placeholder="11974065186">
                </div>
                <div class="form-group">
                    <label>ğŸ” Novo PIN (4 dÃ­gitos)</label>
                    <input type="password" id="novoPin" maxlength="4" placeholder="****">
                </div>
                <div class="form-group">
                    <label>ğŸ’° Valor Corte</label>
                    <input type="number" step="0.01" id="valCorte" placeholder="Valor atual: R$ 28.00">
                </div>
                <div class="form-group">
                    <label>ğŸ’° Valor Barba</label>
                    <input type="number" step="0.01" id="valBarba" placeholder="Valor atual: R$ 15.00">
                </div>
                <div class="form-group">
                    <label>ğŸ’° Valor Combo</label>
                    <input type="number" step="0.01" id="valCombo" placeholder="Valor atual: R$ 40.00">
                </div>
                <div class="form-group">
                    <label>ğŸ’¸ OrÃ§amento Mensal Despesas</label>
                    <input type="number" step="0.01" id="orcamentoDespesas" placeholder="R$ 1500.00">
                </div>
                <div class="form-group">
                    <label>ğŸ”” NotificaÃ§Ãµes de Vencimento</label>
                    <select id="notificacoesAtivas">
                        <option value="true">âœ… Ativas</option>
                        <option value="false">âŒ Desativadas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>â° Dias antes para alerta</label>
                    <input type="number" min="1" max="7" id="diasAlerta" placeholder="3">
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" data-modal="modalConfig">
                    Cancelar
                </button>
                <button class="btn btn-primary" id="btnSalvarConfiguracoes">
                    ğŸ’¾ Salvar ConfiguraÃ§Ãµes
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript COMPLETO E FUNCIONAL -->
    <script>
        // ========== VARIÃVEIS GLOBAIS ==========
let dados = { 
    Gabriel: [
    
    ], 
    Wagner: [
      
    ], 
    despesas: [
    
    ],
    mensalistas: [
     
    ],
    config: { 
        pin: '1234', 
        whatsapp: '11974065186', 
        corte: 28, 
        barba: 15, 
        combo: 40,
        orcamentoDespesas: 1500,
        notificacoesAtivas: true,
        diasAlerta: 3
    }
};

let graficoPizza = null;
let filtroMetodoAtual = null;
let filtroStatusAtual = 'todos';
let notificacaoAtiva = false;
let editandoMensalistaId = null;
let editandoDespesaId = null;

// ========== INICIALIZAÃ‡ÃƒO ==========
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Dashboard inicializando...');
    inicializarDashboard();
});

function inicializarDashboard() {
    // Carregar dados do localStorage se existir
    carregarDados();
    
    // Configurar datas
    configurarDatasDashboard();
    
    // Configurar event listeners
    configurarEventListenersDashboard();
    
    // Inicializar grÃ¡ficos
    inicializarGraficos();
    
    // Atualizar dashboard
    atualizarDashboardCompleto();
    
    // Iniciar verificaÃ§Ãµes periÃ³dicas
    iniciarVerificacoesPeriodicas();
    
    console.log('âœ… Dashboard inicializado!');
}

function carregarDados() {
    try {
        const dadosSalvos = localStorage.getItem('barbapro_duo');
        if (dadosSalvos) {
            const dadosParseados = JSON.parse(dadosSalvos);
            // Mesclar dados salvos com dados padrÃ£o
            Object.keys(dadosParseados).forEach(key => {
                if (dados[key] !== undefined) {
                    dados[key] = dadosParseados[key];
                }
            });
            console.log('ğŸ“‚ Dados carregados do localStorage');
        }
    } catch (error) {
        console.error('âŒ Erro ao carregar dados:', error);
    }
}

function salvarDados() {
    try {
        localStorage.setItem('barbapro_duo', JSON.stringify(dados));
        console.log('ğŸ’¾ Dados salvos localmente');
    } catch (error) {
        console.error('âŒ Erro ao salvar dados:', error);
    }
}

function configurarDatasDashboard() {
    const hoje = new Date();
    const umaSemanaAtras = new Date();
    umaSemanaAtras.setDate(hoje.getDate() - 7);
    
    // Configurar datas padrÃ£o
    const formatarData = (date) => date.toISOString().split('T')[0];
    
    // ServiÃ§os recentes
    document.getElementById('dataInicioServicos').value = formatarData(umaSemanaAtras);
    document.getElementById('dataFimServicos').value = formatarData(hoje);
    
    // Despesas
    document.getElementById('dataInicioDespesas').value = formatarData(umaSemanaAtras);
    document.getElementById('dataFimDespesas').value = formatarData(hoje);
    
    // Pagamentos
    const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    document.getElementById('dataInicioPagamentos').value = formatarData(primeiroDiaMes);
    document.getElementById('dataFimPagamentos').value = formatarData(hoje);
    
    // Mensalistas
    document.getElementById('dataInicioMensalistas').value = formatarData(primeiroDiaMes);
    document.getElementById('dataFimMensalistas').value = formatarData(hoje);
    
    // Novo mensalista
    document.getElementById('dataInicioMensalista').value = formatarData(hoje);
    document.getElementById('diaVencimentoMensalista').value = hoje.getDate();
    
    // Nova despesa
    document.getElementById('dataDespesa').value = formatarData(hoje);
}

function configurarEventListenersDashboard() {
    // BotÃµes principais
    document.getElementById('btnVoltarRegistro').addEventListener('click', voltarParaRegistro);
    document.getElementById('btnConfiguracoes').addEventListener('click', abrirModalConfiguracoes);
    document.getElementById('btnEnviarResumo').addEventListener('click', () => abrirModalResumoCompleto());
    
    // BotÃµes de aÃ§Ã£o rÃ¡pida
    document.getElementById('btnVerResumoCompleto').addEventListener('click', () => abrirModalResumoCompleto());
    document.getElementById('btnRelatorioDetalhado').addEventListener('click', abrirModalPagamentos);
    document.getElementById('btnEnviarMensalistas').addEventListener('click', enviarLembretesMensalistas);
    document.getElementById('btnGerenciarDespesas').addEventListener('click', () => abrirModalDespesas());
    
    // BotÃµes de despesas
    document.getElementById('btnNovaDespesa').addEventListener('click', () => abrirModalDespesas());
    document.getElementById('btnNovaDespesaRapida').addEventListener('click', () => abrirModalDespesas());
    document.getElementById('btnFiltrarDespesas').addEventListener('click', atualizarListaDespesasRecentes);
    document.getElementById('btnExportarDespesas').addEventListener('click', exportarDadosDespesas);
    document.getElementById('btnAdicionarDespesa').addEventListener('click', adicionarOuAtualizarDespesa);
    document.getElementById('btnLimparFormDespesa').addEventListener('click', limparFormDespesa);
    
    // BotÃµes de mensalistas
    document.getElementById('btnNovoMensalista').addEventListener('click', abrirModalMensalistas);
    document.getElementById('btnFiltrarMensalistas').addEventListener('click', () => {
        filtrarMensalistasPorStatus('todos', true);
    });
    document.getElementById('btnLimparFiltros').addEventListener('click', limparFiltrosMensalistas);
    
    // BotÃµes de serviÃ§os
    document.getElementById('btnFiltrarServicos').addEventListener('click', atualizarListaServicosRecentes);
    document.getElementById('btnEnviarRelatorioServicos').addEventListener('click', () => enviarRelatorioWhatsApp('servicos'));
    document.getElementById('btnExportarServicos').addEventListener('click', exportarDadosServicos);
    
    // BotÃµes de pagamentos
    document.getElementById('btnEnviarPagamentos').addEventListener('click', () => abrirModalPagamentos());
    document.getElementById('btnGerarRelatorio').addEventListener('click', gerarRelatorioPagamentosDetalhado);
    document.getElementById('btnEnviarRelatorioWhatsApp').addEventListener('click', () => enviarRelatorioWhatsApp('pagamentos'));
    
    // BotÃµes de formulÃ¡rio
    document.getElementById('btnAdicionarMensalista').addEventListener('click', adicionarOuAtualizarMensalista);
    document.getElementById('btnLimparFormMensalista').addEventListener('click', limparFormMensalista);
    document.getElementById('btnSalvarConfiguracoes').addEventListener('click', salvarConfiguracoes);
    document.getElementById('btnEnviarResumoCompleto').addEventListener('click', () => enviarRelatorioWhatsApp('resumo'));
    
    // BotÃµes de fechar modal
    document.querySelectorAll('.close-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const modalId = this.getAttribute('data-modal');
            fecharModal(modalId);
        });
    });
    
    // Input mask para telefone
    const telefoneInput = document.getElementById('telefoneMensalista');
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 11) value = value.substring(0, 11);
            
            if (value.length > 10) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/^(\d{2})(\d{4})(\d{0,4})$/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/^(\d{2})(\d{0,5})$/, '($1) $2');
            } else if (value.length > 0) {
                value = value.replace(/^(\d{0,2})$/, '($1');
            }
            
            e.target.value = value;
        });
    }
    
    // Fechar modais ao clicar fora
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });
}

function iniciarVerificacoesPeriodicas() {
    // Verificar vencimentos a cada 5 minutos
    setInterval(verificarVencimentosMensalistas, 300000);
    
    // Verificar orÃ§amento de despesas a cada hora
    setInterval(verificarOrcamentoDespesas, 3600000);
    
    // Atualizar dashboard a cada 30 segundos
    setInterval(() => {
        atualizarDashboardCompleto();
    }, 30000);
}

// ========== ATUALIZAÃ‡ÃƒO DO DASHBOARD ==========
function atualizarDashboardCompleto() {
    atualizarEstatisticasBarbeiros();
    atualizarEstatisticasGerais();
    atualizarEstatisticasDespesas();
    atualizarResumoPagamentos();
    atualizarListaDespesasRecentes();
    atualizarListaServicosRecentes();
    atualizarResumoStatusMensalistas();
    filtrarMensalistasPorStatus(filtroStatusAtual);
    atualizarGraficoPizza();
    verificarVencimentosMensalistas();
}

function atualizarEstatisticasBarbeiros() {
    const hoje = new Date().toISOString().split('T')[0];
    
    // Gabriel
    const servicosGabrielHoje = dados.Gabriel.filter(s => s.data === hoje);
    const totalGabrielHoje = servicosGabrielHoje.reduce((sum, s) => sum + s.valor, 0);
    const fiadoGabrielHoje = servicosGabrielHoje.filter(s => !s.pago).reduce((sum, s) => sum + s.valor, 0);
    const mediaGabriel = servicosGabrielHoje.length > 0 ? (totalGabrielHoje / servicosGabrielHoje.length) : 0;
    
    // Atualizar Gabriel
    document.getElementById('gabrielHoje').textContent = servicosGabrielHoje.length;
    document.getElementById('gabrielTotalHoje').textContent = `R$ ${totalGabrielHoje.toFixed(2)}`;
    document.getElementById('gabrielFiadoHoje').textContent = `R$ ${fiadoGabrielHoje.toFixed(2)}`;
    document.getElementById('gabrielMedia').textContent = `R$ ${mediaGabriel.toFixed(2)}`;
    
    // Wagner
    const servicosWagnerHoje = dados.Wagner.filter(s => s.data === hoje);
    const totalWagnerHoje = servicosWagnerHoje.reduce((sum, s) => sum + s.valor, 0);
    const fiadoWagnerHoje = servicosWagnerHoje.filter(s => !s.pago).reduce((sum, s) => sum + s.valor, 0);
    const mediaWagner = servicosWagnerHoje.length > 0 ? (totalWagnerHoje / servicosWagnerHoje.length) : 0;
    
    // Atualizar Wagner
    document.getElementById('wagnerHoje').textContent = servicosWagnerHoje.length;
    document.getElementById('wagnerTotalHoje').textContent = `R$ ${totalWagnerHoje.toFixed(2)}`;
    document.getElementById('wagnerFiadoHoje').textContent = `R$ ${fiadoWagnerHoje.toFixed(2)}`;
    document.getElementById('wagnerMedia').textContent = `R$ ${mediaWagner.toFixed(2)}`;
}

function atualizarEstatisticasGerais() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    // Calcular totais do mÃªs
    const servicosGabrielMes = dados.Gabriel.filter(s => {
        const dataServico = new Date(s.data);
        return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
    });
    
    const servicosWagnerMes = dados.Wagner.filter(s => {
        const dataServico = new Date(s.data);
        return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
    });
    
    const totalGabrielMes = servicosGabrielMes.reduce((sum, s) => sum + s.valor, 0);
    const totalWagnerMes = servicosWagnerMes.reduce((sum, s) => sum + s.valor, 0);
    const totalMes = totalGabrielMes + totalWagnerMes;
    const servicosMes = servicosGabrielMes.length + servicosWagnerMes.length;
    
    const fiadoMes = [...dados.Gabriel, ...dados.Wagner]
        .filter(s => {
            const dataServico = new Date(s.data);
            return dataServico.getMonth() === mesAtual && 
                   dataServico.getFullYear() === anoAtual && 
                   !s.pago;
        })
        .reduce((sum, s) => sum + s.valor, 0);
    
    const despesasMes = dados.despesas.filter(d => {
        const dataDespesa = new Date(d.data);
        return dataDespesa.getMonth() === mesAtual && dataDespesa.getFullYear() === anoAtual;
    }).reduce((sum, d) => sum + d.valor, 0);
    
    document.getElementById('totalMes').textContent = `R$ ${totalMes.toFixed(2)}`;
    document.getElementById('servicosMes').textContent = servicosMes;
    document.getElementById('fiadoMes').textContent = `R$ ${fiadoMes.toFixed(2)}`;
    document.getElementById('despesasMes').textContent = `R$ ${despesasMes.toFixed(2)}`;
}

function atualizarEstatisticasDespesas() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    // Filtrar despesas do mÃªs
    const despesasMes = dados.despesas.filter(d => {
        const dataDespesa = new Date(d.data);
        return dataDespesa.getMonth() === mesAtual && dataDespesa.getFullYear() === anoAtual;
    });
    
    // Calcular estatÃ­sticas
    const totalDespesasMes = despesasMes.reduce((sum, d) => sum + d.valor, 0);
    const numDespesasMes = despesasMes.length;
    const maiorDespesaMes = despesasMes.length > 0 ? Math.max(...despesasMes.map(d => d.valor)) : 0;
    
    // Calcular lucro lÃ­quido
    const totalReceitaMes = document.getElementById('totalMes').textContent.replace('R$ ', '').replace(',', '.');
    const totalReceita = parseFloat(totalReceitaMes) || 0;
    const lucroLiquido = totalReceita - totalDespesasMes;
    
    // Atualizar cards
    document.getElementById('totalDespesasMes').textContent = `R$ ${totalDespesasMes.toFixed(2)}`;
    document.getElementById('numDespesasMes').textContent = numDespesasMes;
    document.getElementById('maiorDespesaMes').textContent = `R$ ${maiorDespesaMes.toFixed(2)}`;
    document.getElementById('lucroLiquido').textContent = `R$ ${lucroLiquido.toFixed(2)}`;
    
    // Aplicar cor ao lucro (verde se positivo, vermelho se negativo)
    const lucroElement = document.getElementById('lucroLiquido');
    if (lucroElement) {
        if (lucroLiquido > 0) {
            lucroElement.style.color = '#25D366';
        } else if (lucroLiquido < 0) {
            lucroElement.style.color = '#ff3366';
        }
    }
}

function atualizarResumoPagamentos() {
    const hoje = new Date().toISOString().split('T')[0];
    const todosServicos = [...dados.Gabriel, ...dados.Wagner];
    const servicosHoje = todosServicos.filter(s => s.data === hoje);
    
    // Calcular por mÃ©todo de pagamento
    const totalDinheiro = servicosHoje.filter(s => s.metodoPagamento === 'dinheiro').reduce((sum, s) => sum + s.valor, 0);
    const totalPix = servicosHoje.filter(s => s.metodoPagamento === 'pix').reduce((sum, s) => sum + s.valor, 0);
    const totalDebito = servicosHoje.filter(s => s.metodoPagamento === 'debito').reduce((sum, s) => sum + s.valor, 0);
    const totalCredito = servicosHoje.filter(s => s.metodoPagamento === 'credito').reduce((sum, s) => sum + s.valor, 0);
    
    document.getElementById('totalDinheiro').textContent = `R$ ${totalDinheiro.toFixed(2)}`;
    document.getElementById('totalPix').textContent = `R$ ${totalPix.toFixed(2)}`;
    document.getElementById('totalDebito').textContent = `R$ ${totalDebito.toFixed(2)}`;
    document.getElementById('totalCredito').textContent = `R$ ${totalCredito.toFixed(2)}`;
}

function inicializarGraficos() {
    const ctxPizza = document.getElementById('graficoPizza');
    if (!ctxPizza) return;
    
    graficoPizza = new Chart(ctxPizza.getContext('2d'), {
        type: 'pie',
        data: {
            labels: ['Gabriel', 'Wagner', 'Fiado'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(255, 170, 0, 0.8)',
                    'rgba(51, 102, 255, 0.8)',
                    'rgba(255, 51, 102, 0.8)'
                ],
                borderColor: [
                    'rgba(255, 170, 0, 1)',
                    'rgba(51, 102, 255, 1)',
                    'rgba(255, 51, 102, 1)'
                ],
                borderWidth: 2,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#fff',
                        padding: 20,
                        font: {
                            size: 13,
                            family: "'Segoe UI', sans-serif"
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#ffaa00',
                    bodyColor: '#fff',
                    borderColor: '#ffaa00',
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${label}: R$ ${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
}

function atualizarGraficoPizza() {
    if (!graficoPizza) return;
    
    const hoje = new Date().toISOString().split('T')[0];
    
    const totalGabriel = dados.Gabriel.filter(s => s.data === hoje).reduce((sum, s) => sum + s.valor, 0);
    const totalWagner = dados.Wagner.filter(s => s.data === hoje).reduce((sum, s) => sum + s.valor, 0);
    const totalFiado = [...dados.Gabriel, ...dados.Wagner]
        .filter(s => s.data === hoje && !s.pago)
        .reduce((sum, s) => sum + s.valor, 0);
    
    graficoPizza.data.datasets[0].data = [totalGabriel, totalWagner, totalFiado];
    graficoPizza.update();
}

// ========== FUNÃ‡Ã•ES DE DESPESAS ==========
function atualizarListaDespesasRecentes() {
    const dataInicio = document.getElementById('dataInicioDespesas').value;
    const dataFim = document.getElementById('dataFimDespesas').value;
    const filtroCategoria = document.getElementById('filtroCategoriaDespesas').value;
    
    let despesasFiltradas = [...dados.despesas];
    
    // Aplicar filtros
    if (dataInicio && dataFim) {
        despesasFiltradas = despesasFiltradas.filter(d => 
            d.data >= dataInicio && d.data <= dataFim
        );
    }
    
    if (filtroCategoria !== 'todos') {
        despesasFiltradas = despesasFiltradas.filter(d => d.categoria === filtroCategoria);
    }
    
    // Ordenar por data (mais recente primeiro)
    despesasFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
    
    // Calcular totais
    const totalFiltrado = despesasFiltradas.reduce((sum, d) => sum + d.valor, 0);
    const mediaDespesa = despesasFiltradas.length > 0 ? (totalFiltrado / despesasFiltradas.length) : 0;
    
    let html = '';
    
    if (despesasFiltradas.length > 0) {
        html = `
            <div style="background: rgba(255,51,102,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 12px; color: #ff99bb;">TOTAL FILTRADO</div>
                        <div style="font-size: 24px; font-weight: 700; color: #ff3366;">R$ ${totalFiltrado.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #ff99bb;">DESPESAS</div>
                        <div style="font-size: 24px; font-weight: 700; color: #fff;">${despesasFiltradas.length}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #ff99bb;">MÃ‰DIA/DESPESA</div>
                        <div style="font-size: 20px; font-weight: 600; color: #ff6699;">R$ ${mediaDespesa.toFixed(2)}</div>
                    </div>
                </div>
            </div>
        `;
        
        // Agrupar por data
        const despesasPorData = {};
        despesasFiltradas.forEach(despesa => {
            const data = despesa.data;
            if (!despesasPorData[data]) {
                despesasPorData[data] = [];
            }
            despesasPorData[data].push(despesa);
        });
        
        // Criar cards por data
        Object.keys(despesasPorData).sort().reverse().slice(0, 10).forEach(data => {
            const despesasDoDia = despesasPorData[data];
            const totalDia = despesasDoDia.reduce((sum, d) => sum + d.valor, 0);
            
            html += `
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-weight: 600; color: #fff;">${formatarDataBR(data)}</div>
                        <div style="font-size: 14px; color: #ff3366; font-weight: 600;">Total: R$ ${totalDia.toFixed(2)}</div>
                    </div>
            `;
            
            despesasDoDia.forEach(despesa => {
                const tagsHtml = despesa.tags ? despesa.tags.map(tag => 
                    `<span style="background: rgba(255,255,255,0.1); color: #aaa; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-right: 5px;">${tag}</span>`
                ).join('') : '';
                
                html += `
                    <div class="despesa-card" id="despesa-${despesa.id}">
                        <div class="despesa-header">
                            <div>
                                <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">${despesa.descricao}</div>
                                <div class="despesa-categoria">${despesa.categoria}</div>
                            </div>
                            <div class="despesa-valor">R$ ${despesa.valor.toFixed(2)}</div>
                        </div>
                        
                        <div class="despesa-detalhes">
                            <div>
                                <div style="font-size: 11px; color: #888;">Data</div>
                                <div>${formatarDataBR(despesa.data)}</div>
                            </div>
                            ${despesa.comprovante ? `
                                <div>
                                    <div style="font-size: 11px; color: #888;">Comprovante</div>
                                    <div>${despesa.comprovante}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${tagsHtml ? `
                            <div style="margin-top: 10px;">
                                ${tagsHtml}
                            </div>
                        ` : ''}
                        
                        ${despesa.observacoes ? `
                            <div style="margin-top: 10px; font-size: 13px; color: #aaa; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                                ğŸ“ ${despesa.observacoes}
                            </div>
                        ` : ''}
                        
                        <div class="despesa-actions">
                            <button class="action-btn edit" onclick="editarDespesa(${despesa.id})" data-tooltip="Editar">
                                âœï¸
                            </button>
                            <button class="action-btn" onclick="removerDespesa(${despesa.id})" data-tooltip="Remover" style="background: rgba(255,0,0,0.2); color: #ff0000;">
                                Ã—
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        });
        
        html += `
            <div style="text-align: center; margin-top: 20px; color: #aaa; font-size: 14px;">
                Mostrando ${Math.min(despesasFiltradas.length, 50)} despesas
                ${despesasFiltradas.length > 50 ? '(use filtros para ver mais)' : ''}
            </div>
        `;
    } else {
        html = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ’¸</div>
                <div class="empty-state-title">Nenhuma despesa encontrada</div>
                <div class="empty-state-subtitle">
                    ${filtroCategoria !== 'todos' ? 'Tente ajustar os filtros ou ' : ''}cadastre sua primeira despesa
                </div>
                <button class="btn btn-danger" onclick="abrirModalDespesas()" style="margin-top: 20px;">
                    + Adicionar Despesa
                </button>
            </div>
        `;
    }
    
    document.getElementById('listaDespesasRecentes').innerHTML = html;
}

function abrirModalDespesas() {
    // Atualizar resumo financeiro
    atualizarResumoFinanceiroDespesas();
    
    // Atualizar lista de despesas no modal
    atualizarListaDespesasModal();
    
    // Abrir modal
    document.getElementById('modalDespesas').style.display = 'flex';
}

function atualizarResumoFinanceiroDespesas() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    // Despesas do mÃªs
    const despesasMes = dados.despesas.filter(d => {
        const dataDespesa = new Date(d.data);
        return dataDespesa.getMonth() === mesAtual && dataDespesa.getFullYear() === anoAtual;
    });
    
    const totalDespesas = despesasMes.reduce((sum, d) => sum + d.valor, 0);
    const orcamento = dados.config.orcamentoDespesas || 1500;
    const percentualUsado = (totalDespesas / orcamento) * 100;
    
    // Calcular por categoria
    const categorias = {};
    despesasMes.forEach(d => {
        if (!categorias[d.categoria]) {
            categorias[d.categoria] = 0;
        }
        categorias[d.categoria] += d.valor;
    });
    
    let categoriasHtml = '';
    Object.keys(categorias).forEach(categoria => {
        const totalCategoria = categorias[categoria];
        const percentualCategoria = (totalCategoria / totalDespesas) * 100;
        
        categoriasHtml += `
            <div class="categoria-item">
                <div>${categoria}</div>
                <div class="categoria-total">R$ ${totalCategoria.toFixed(2)}</div>
            </div>
            <div class="progresso-despesa">
                <div class="progresso-bar" style="width: ${percentualCategoria}%;"></div>
            </div>
        `;
    });
    
    const html = `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
            <div>
                <div style="font-size: 12px; color: #aaa;">ORÃ‡AMENTO MENSAL</div>
                <div style="font-size: 24px; font-weight: 700; color: #fff;">R$ ${orcamento.toFixed(2)}</div>
            </div>
            <div>
                <div style="font-size: 12px; color: #aaa;">DESPESAS MÃŠS</div>
                <div style="font-size: 24px; font-weight: 700; color: ${totalDespesas > orcamento ? '#ff3366' : '#25D366'};">R$ ${totalDespesas.toFixed(2)}</div>
            </div>
        </div>
        
        <div class="progresso-despesa" style="margin: 15px 0;">
            <div class="progresso-bar" style="width: ${Math.min(percentualUsado, 100)}%; background: ${percentualUsado > 100 ? 'linear-gradient(90deg, #ff3366, #ff0066)' : 'linear-gradient(90deg, #ff3366, #ff6699)'};"></div>
        </div>
        
        <div style="text-align: center; margin: 10px 0; color: ${percentualUsado > 100 ? '#ff3366' : '#aaa'};">
            ${percentualUsado.toFixed(1)}% do orÃ§amento utilizado
            ${percentualUsado > 100 ? 'âš ï¸ EXCEDIDO!' : ''}
        </div>
        
        <div style="margin-top: 20px;">
            <div style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">ğŸ“Š DISTRIBUIÃ‡ÃƒO POR CATEGORIA</div>
            ${categoriasHtml || '<div style="text-align: center; color: #aaa; padding: 20px;">Nenhuma despesa registrada este mÃªs</div>'}
        </div>
    `;
    
    document.getElementById('resumoFinanceiroDespesas').innerHTML = html;
}

function atualizarListaDespesasModal() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    const despesasMes = dados.despesas.filter(d => {
        const dataDespesa = new Date(d.data);
        return dataDespesa.getMonth() === mesAtual && dataDespesa.getFullYear() === anoAtual;
    }).sort((a, b) => new Date(b.data) - new Date(a.data));
    
    let html = '';
    
    if (despesasMes.length > 0) {
        html = `
            <div style="background: rgba(255,255,255,0.03); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <div style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">ğŸ“… DESPESAS DESTE MÃŠS (${despesasMes.length})</div>
            </div>
        `;
        
        despesasMes.forEach(despesa => {
            html += `
                <div class="despesa-card" id="despesa-modal-${despesa.id}">
                    <div class="despesa-header">
                        <div>
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">${despesa.descricao}</div>
                            <div class="despesa-categoria">${despesa.categoria}</div>
                        </div>
                        <div class="despesa-valor">R$ ${despesa.valor.toFixed(2)}</div>
                    </div>
                    
                    <div class="despesa-detalhes">
                        <div>
                            <div style="font-size: 11px; color: #888;">Data</div>
                            <div>${formatarDataBR(despesa.data)}</div>
                        </div>
                        ${despesa.comprovante ? `
                            <div>
                                <div style="font-size: 11px; color: #888;">Comprovante</div>
                                <div>${despesa.comprovante}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="despesa-actions">
                        <button class="action-btn edit" onclick="editarDespesa(${despesa.id})" data-tooltip="Editar">
                            âœï¸
                        </button>
                        <button class="action-btn" onclick="removerDespesa(${despesa.id})" data-tooltip="Remover" style="background: rgba(255,0,0,0.2); color: #ff0000;">
                            Ã—
                        </button>
                    </div>
                </div>
            `;
        });
    } else {
        html = `
            <div style="text-align: center; padding: 40px; color: #aaa;">
                <div style="font-size: 48px; margin-bottom: 20px;">ğŸ’¸</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Nenhuma despesa este mÃªs</div>
                <div>Registre sua primeira despesa usando o formulÃ¡rio acima</div>
            </div>
        `;
    }
    
    document.getElementById('listaDespesasModal').innerHTML = html;
}

function adicionarOuAtualizarDespesa() {
    const descricao = document.getElementById('descricaoDespesa').value.trim();
    const categoria = document.getElementById('categoriaDespesa').value;
    const valor = parseFloat(document.getElementById('valorDespesa').value);
    const data = document.getElementById('dataDespesa').value;
    const tags = document.getElementById('tagsDespesa').value.trim();
    const comprovante = document.getElementById('comprovanteDespesa').value.trim();
    const observacoes = document.getElementById('observacoesDespesa').value.trim();
    
    if (!descricao || !categoria || isNaN(valor) || !data) {
        alert('âŒ Preencha todos os campos obrigatÃ³rios!');
        return;
    }
    
    if (editandoDespesaId) {
        // Atualizar despesa existente
        atualizarDespesa(editandoDespesaId, descricao, categoria, valor, data, tags, comprovante, observacoes);
    } else {
        // Adicionar nova despesa
        adicionarNovaDespesa(descricao, categoria, valor, data, tags, comprovante, observacoes);
    }
}

function adicionarNovaDespesa(descricao, categoria, valor, data, tags, comprovante, observacoes) {
    // Gerar ID Ãºnico
    const id = dados.despesas.length > 0 ? Math.max(...dados.despesas.map(d => d.id)) + 1 : 1;
    
    const novaDespesa = {
        id: id,
        data: data,
        descricao: descricao,
        categoria: categoria,
        valor: valor,
        tags: tags ? tags.split(',').map(t => t.trim()) : [],
        comprovante: comprovante,
        observacoes: observacoes
    };
    
    dados.despesas.push(novaDespesa);
    salvarDados();
    
    // Limpar formulÃ¡rio
    limparFormDespesa();
    
    // Atualizar interface
    atualizarDashboardCompleto();
    
    // Mostrar confirmaÃ§Ã£o
    alert(`âœ… Despesa "${descricao}" registrada com sucesso!`);
}

function atualizarDespesa(id, descricao, categoria, valor, data, tags, comprovante, observacoes) {
    const despesa = dados.despesas.find(d => d.id === id);
    if (!despesa) {
        alert('âŒ Despesa nÃ£o encontrada!');
        return;
    }
    
    // Atualizar dados
    despesa.descricao = descricao;
    despesa.categoria = categoria;
    despesa.valor = valor;
    despesa.data = data;
    despesa.tags = tags ? tags.split(',').map(t => t.trim()) : [];
    despesa.comprovante = comprovante;
    despesa.observacoes = observacoes;
    
    salvarDados();
    
    // Resetar modo ediÃ§Ã£o
    editandoDespesaId = null;
    document.getElementById('btnAdicionarDespesa').textContent = 'ğŸ’¾ Registrar Despesa';
    
    // Limpar formulÃ¡rio
    limparFormDespesa();
    
    // Atualizar interface
    atualizarDashboardCompleto();
    
    alert(`âœ… Despesa "${descricao}" atualizada com sucesso!`);
}

function editarDespesa(id) {
    const despesa = dados.despesas.find(d => d.id === id);
    if (!despesa) {
        alert('âŒ Despesa nÃ£o encontrada!');
        return;
    }
    
    // Preencher formulÃ¡rio
    document.getElementById('descricaoDespesa').value = despesa.descricao;
    document.getElementById('categoriaDespesa').value = despesa.categoria;
    document.getElementById('valorDespesa').value = despesa.valor;
    document.getElementById('dataDespesa').value = despesa.data;
    document.getElementById('tagsDespesa').value = despesa.tags ? despesa.tags.join(', ') : '';
    document.getElementById('comprovanteDespesa').value = despesa.comprovante || '';
    document.getElementById('observacoesDespesa').value = despesa.observacoes || '';
    
    // Mudar para modo ediÃ§Ã£o
    editandoDespesaId = id;
    document.getElementById('btnAdicionarDespesa').textContent = 'ğŸ’¾ Atualizar Despesa';
    
    // Abrir modal
    abrirModalDespesas();
}

function removerDespesa(id) {
    if (!confirm('âš ï¸ Tem certeza que deseja remover esta despesa?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita.')) {
        return;
    }
    
    const index = dados.despesas.findIndex(d => d.id === id);
    if (index === -1) {
        alert('âŒ Despesa nÃ£o encontrada!');
        return;
    }
    
    const descricaoRemovida = dados.despesas[index].descricao;
    dados.despesas.splice(index, 1);
    salvarDados();
    
    // Atualizar interface
    atualizarDashboardCompleto();
    
    alert(`ğŸ—‘ï¸ Despesa "${descricaoRemovida}" removida com sucesso!`);
}

function exportarDadosDespesas() {
    const dataInicio = document.getElementById('dataInicioDespesas').value;
    const dataFim = document.getElementById('dataFimDespesas').value;
    const filtroCategoria = document.getElementById('filtroCategoriaDespesas').value;
    
    let despesas = dados.despesas.filter(d => {
        if (d.data < dataInicio || d.data > dataFim) return false;
        if (filtroCategoria !== 'todos' && d.categoria !== filtroCategoria) return false;
        return true;
    });
    
    // Converter para CSV
    let csv = 'Data,DescriÃ§Ã£o,Categoria,Valor,Tags,Comprovante,ObservaÃ§Ãµes\n';
    
    despesas.forEach(d => {
        const linha = [
            d.data,
            d.descricao,
            d.categoria,
            d.valor.toFixed(2),
            d.tags ? d.tags.join('; ') : '',
            d.comprovante || '',
            d.observacoes || ''
        ].map(campo => `"${campo}"`).join(',');
        
        csv += linha + '\n';
    });
    
    // Criar arquivo e baixar
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `despesas_${dataInicio}_a_${dataFim}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`ğŸ“¥ Arquivo CSV gerado com ${despesas.length} despesas!`);
}

function verificarOrcamentoDespesas() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    const despesasMes = dados.despesas.filter(d => {
        const dataDespesa = new Date(d.data);
        return dataDespesa.getMonth() === mesAtual && dataDespesa.getFullYear() === anoAtual;
    });
    
    const totalDespesas = despesasMes.reduce((sum, d) => sum + d.valor, 0);
    const orcamento = dados.config.orcamentoDespesas || 1500;
    const percentual = (totalDespesas / orcamento) * 100;
    
    if (percentual > 90 && percentual <= 100 && !notificacaoAtiva) {
        mostrarNotificacaoOrcamento(percentual, totalDespesas, orcamento);
    } else if (percentual > 100) {
        mostrarNotificacaoOrcamentoExcedido(percentual, totalDespesas, orcamento);
    }
}

function mostrarNotificacaoOrcamento(percentual, total, orcamento) {
    const notificacao = document.getElementById('pushNotification');
    const title = document.getElementById('pushNotificationTitle');
    const message = document.getElementById('pushNotificationMessage');
    
    if (!notificacao || !title || !message) return;
    
    title.innerHTML = 'ğŸ’° ALERTA DE ORÃ‡AMENTO';
    message.textContent = `Despesas atingiram ${percentual.toFixed(1)}% do orÃ§amento (R$ ${total.toFixed(2)}/${orcamento.toFixed(2)})`;
    
    notificacao.style.display = 'block';
    notificacao.style.background = 'linear-gradient(135deg, rgba(255,149,0,0.9), rgba(255,107,0,0.9))';
    notificacaoAtiva = true;
    
    setTimeout(() => {
        fecharNotificacao();
    }, 10000);
}

function mostrarNotificacaoOrcamentoExcedido(percentual, total, orcamento) {
    const notificacao = document.getElementById('pushNotification');
    const title = document.getElementById('pushNotificationTitle');
    const message = document.getElementById('pushNotificationMessage');
    
    if (!notificacao || !title || !message) return;
    
    title.innerHTML = 'âš ï¸ ORÃ‡AMENTO EXCEDIDO';
    message.textContent = `Despesas excederam o orÃ§amento em ${(percentual-100).toFixed(1)}% (R$ ${total.toFixed(2)}/${orcamento.toFixed(2)})`;
    
    notificacao.style.display = 'block';
    notificacao.style.background = 'linear-gradient(135deg, rgba(255,51,102,0.9), rgba(255,0,51,0.9))';
    notificacaoAtiva = true;
    
    setTimeout(() => {
        fecharNotificacao();
    }, 15000);
}

function limparFormDespesa() {
    document.getElementById('descricaoDespesa').value = '';
    document.getElementById('valorDespesa').value = '';
    document.getElementById('tagsDespesa').value = '';
    document.getElementById('comprovanteDespesa').value = '';
    document.getElementById('observacoesDespesa').value = '';
    
    // Resetar valores padrÃ£o
    const hoje = new Date();
    document.getElementById('dataDespesa').value = hoje.toISOString().split('T')[0];
    
    // Resetar modo ediÃ§Ã£o
    editandoDespesaId = null;
    document.getElementById('btnAdicionarDespesa').textContent = 'ğŸ’¾ Registrar Despesa';
}

// ========== FUNÃ‡Ã•ES DE MENSALISTAS ==========
function atualizarResumoStatusMensalistas() {
    const hoje = new Date();
    const mensalistas = dados.mensalistas;
    
    // Contar por status
    const pagos = mensalistas.filter(m => m.status === 'pago').length;
    const pendentes = mensalistas.filter(m => m.status === 'pendente').length;
    const vencidos = mensalistas.filter(m => m.status === 'vencido').length;
    
    // Contar vencimentos hoje
    const vencemHoje = mensalistas.filter(m => {
        if (m.status === 'pago') return false;
        const dataVenc = new Date(m.dataVencimento || m.vencimento);
        const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
        return diffDias === 0;
    }).length;
    
    // Atualizar contadores
    document.getElementById('counterTodos').textContent = mensalistas.length;
    document.getElementById('counterPagos').textContent = pagos;
    document.getElementById('counterPendentes').textContent = pendentes;
    document.getElementById('counterVencidos').textContent = vencidos;
    document.getElementById('counterHoje').textContent = vencemHoje;
    
    // Atualizar resumo visual
    const html = `
        <div class="status-card pago">
            <div class="status-card-label">âœ… PAGOS</div>
            <div class="status-card-total">${pagos}</div>
        </div>
        <div class="status-card pendente">
            <div class="status-card-label">â³ PENDENTES</div>
            <div class="status-card-total">${pendentes}</div>
        </div>
        <div class="status-card vencido">
            <div class="status-card-label">âš ï¸ VENCIDOS</div>
            <div class="status-card-total">${vencidos}</div>
        </div>
        <div class="status-card" style="border-top: 4px solid #ffaa00;">
            <div class="status-card-label">ğŸ“… VENCE HOJE</div>
            <div class="status-card-total" style="color: #ffaa00;">${vencemHoje}</div>
        </div>
    `;
    
    document.getElementById('resumoStatusMensalistas').innerHTML = html;
}

function filtrarMensalistasPorStatus(status, usarFiltrosAvancados = false) {
    filtroStatusAtual = status;
    
    // Atualizar botÃµes ativos
    document.querySelectorAll('.status-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const btnAtivo = Array.from(document.querySelectorAll('.status-btn')).find(btn => 
        btn.textContent.includes(status === 'todos' ? 'Todos' : 
                                status === 'pago' ? 'Pagos' : 
                                status === 'pendente' ? 'Pendentes' : 
                                status === 'vencido' ? 'Vencidos' : 'Vence Hoje')
    );
    
    if (btnAtivo) btnAtivo.classList.add('active');
    
    // Aplicar filtros
    const hoje = new Date();
    let mensalistasFiltrados = [...dados.mensalistas];
    
    // Filtro por status
    if (status !== 'todos') {
        if (status === 'hoje') {
            mensalistasFiltrados = mensalistasFiltrados.filter(m => {
                if (m.status === 'pago') return false;
                const dataVenc = new Date(m.dataVencimento || m.vencimento);
                const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                return diffDias === 0;
            });
        } else {
            mensalistasFiltrados = mensalistasFiltrados.filter(m => m.status === status);
        }
    }
    
    // Aplicar filtros avanÃ§ados se solicitado
    if (usarFiltrosAvancados) {
        const dataInicio = document.getElementById('dataInicioMensalistas').value;
        const dataFim = document.getElementById('dataFimMensalistas').value;
        const filtroStatusAvancado = document.getElementById('filtroStatusMensalistas').value;
        const filtroBarbeiro = document.getElementById('filtroBarbeiroMensalistas').value;
        
        if (dataInicio && dataFim) {
            mensalistasFiltrados = mensalistasFiltrados.filter(mensalista => {
                const dataVenc = new Date(mensalista.dataVencimento || mensalista.vencimento || mensalista.dataInicio);
                const dataInicioDate = new Date(dataInicio);
                const dataFimDate = new Date(dataFim);
                
                if (dataVenc < dataInicioDate || dataVenc > dataFimDate) return false;
                if (filtroStatusAvancado !== 'todos' && mensalista.status !== filtroStatusAvancado) return false;
                if (filtroBarbeiro !== 'todos' && mensalista.barbeiro !== filtroBarbeiro) return false;
                
                return true;
            });
        }
    }
    
    // Ordenar por status (vencidos primeiro) e data
    mensalistasFiltrados.sort((a, b) => {
        // Ordem por status: vencido > pendente > pago
        const statusOrder = { 'vencido': 1, 'pendente': 2, 'pago': 3 };
        if (statusOrder[a.status] !== statusOrder[b.status]) {
            return statusOrder[a.status] - statusOrder[b.status];
        }
        
        // Por data de vencimento
        const dataA = new Date(a.dataVencimento || a.vencimento);
        const dataB = new Date(b.dataVencimento || b.vencimento);
        return dataA - dataB;
    });
    
    // Gerar HTML
    let html = '';
    
    if (mensalistasFiltrados.length > 0) {
        mensalistasFiltrados.forEach(mensalista => {
            const statusClass = mensalista.status === 'pago' ? 'status-pago' : 
                              mensalista.status === 'pendente' ? 'status-pendente' : 'status-vencido';
            const statusTexto = mensalista.status === 'pago' ? 'âœ… PAGO' : 
                               mensalista.status === 'pendente' ? 'â³ PENDENTE' : 'âš ï¸ VENCIDO';
            
            const dataVencimento = mensalista.dataVencimento || mensalista.vencimento;
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const vencimento = new Date(dataVencimento);
            vencimento.setHours(0, 0, 0, 0);
            const diffDias = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
            
            let vencimentoTexto = '';
            let vencimentoClass = '';
            
            if (mensalista.status === 'pago') {
                vencimentoTexto = `ğŸ“… PrÃ³ximo: ${formatarDataBR(calcularProximoVencimento(dataVencimento))}`;
            } else if (diffDias > 0) {
                vencimentoTexto = `ğŸ“… Vence em ${diffDias} ${diffDias === 1 ? 'dia' : 'dias'}`;
                vencimentoClass = diffDias <= 3 ? 'proximo' : '';
            } else if (diffDias === 0) {
                vencimentoTexto = 'âš ï¸ VENCE HOJE!';
                vencimentoClass = 'hoje';
            } else {
                vencimentoTexto = `â° Vencido hÃ¡ ${Math.abs(diffDias)} ${Math.abs(diffDias) === 1 ? 'dia' : 'dias'}`;
                vencimentoClass = 'vencido';
            }
            
            // Determinar classe do card
            let cardClass = 'mensalista-card';
            if (mensalista.status === 'vencido') cardClass += ' vencido';
            if (mensalista.status === 'pendente' && diffDias <= 3) cardClass += ' pendente';
            
            html += `
                <div class="${cardClass}" id="mensalista-${mensalista.id}">
                    <div class="mensalista-header">
                        <div>
                            <div class="mensalista-nome">${mensalista.nome}</div>
                            <span class="badge ${mensalista.barbeiro === 'Gabriel' ? 'badge-warning' : 'badge-success'}" style="margin-top: 5px;">
                                ${mensalista.barbeiro}
                            </span>
                        </div>
                        <div class="mensalista-actions">
                            <span class="status-tag ${statusClass}">${statusTexto}</span>
                            ${mensalista.status !== 'pago' ? `
                                <button class="action-btn success" onclick="pagarMensalidade(${mensalista.id})" data-tooltip="Pagar mensalidade">
                                    ğŸ’°
                                </button>
                            ` : ''}
                            ${mensalista.telefone ? `
                                <button class="action-btn whatsapp" onclick="enviarLembreteMensalista(${mensalista.id})" data-tooltip="Enviar lembrete">
                                    ğŸ“±
                                </button>
                            ` : ''}
                            <button class="action-btn edit" onclick="editarMensalista(${mensalista.id})" data-tooltip="Editar">
                                âœï¸
                            </button>
                            <button class="action-btn" onclick="removerMensalista(${mensalista.id})" data-tooltip="Remover mensalista" style="background: rgba(255,0,0,0.2); color: #ff0000;">
                                Ã—
                            </button>
                        </div>
                    </div>
                    <div class="mensalista-detalhes">
                        <div class="mensalista-detalhes-item">
                            <div class="mensalista-detalhes-label">Valor Mensal</div>
                            <div class="mensalista-valor">R$ ${mensalista.valor.toFixed(2)}</div>
                        </div>
                        <div class="mensalista-detalhes-item">
                            <div class="mensalista-detalhes-label">Vencimento</div>
                            <div class="mensalista-detalhes-value">${formatarDataBR(dataVencimento)}</div>
                        </div>
                        <div class="mensalista-detalhes-item">
                            <div class="mensalista-detalhes-label">Status</div>
                            <div class="mensalista-vencimento ${vencimentoClass}">${vencimentoTexto}</div>
                        </div>
                        ${mensalista.telefone ? `
                            <div class="mensalista-detalhes-item">
                                <div class="mensalista-detalhes-label">Contato</div>
                                <div class="mensalista-telefone">${mensalista.telefone}</div>
                            </div>
                        ` : ''}
                    </div>
                    ${mensalista.observacoes ? `
                        <div style="font-size: 12px; color: #888; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                            ğŸ“ ${mensalista.observacoes}
                        </div>
                    ` : ''}
                </div>
            `;
        });
    } else {
        html = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ‘¥</div>
                <div class="empty-state-title">Nenhum mensalista encontrado</div>
                <div class="empty-state-subtitle">
                    ${status === 'vencido' ? 'âœ… Todos os mensalistas estÃ£o em dia!' : 
                      status === 'hoje' ? 'ğŸ‰ NinguÃ©m vence hoje!' : 
                      'Tente ajustar os filtros ou cadastre um novo mensalista'}
                </div>
                <button class="btn btn-success" onclick="abrirModalMensalistas()" style="margin-top: 20px;">
                    + Adicionar Mensalista
                </button>
            </div>
        `;
    }
    
    document.getElementById('listaMensalistasDashboard').innerHTML = html;
}

function limparFiltrosMensalistas() {
    document.getElementById('dataInicioMensalistas').value = '';
    document.getElementById('dataFimMensalistas').value = '';
    document.getElementById('filtroStatusMensalistas').value = 'todos';
    document.getElementById('filtroBarbeiroMensalistas').value = 'todos';
    
    filtrarMensalistasPorStatus('todos');
}

function verificarVencimentosMensalistas() {
    if (!dados.config.notificacoesAtivas) return;
    
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);
    const diasAlerta = dados.config.diasAlerta || 3;
    
    let alertasHTML = '';
    let vencidosParaNotificar = [];
    let proximosParaNotificar = [];
    
    dados.mensalistas.forEach(mensalista => {
        if (mensalista.status === 'pago') return;
        
        const dataVencimento = new Date(mensalista.dataVencimento || mensalista.vencimento);
        dataVencimento.setHours(0, 0, 0, 0);
        
        const diffDias = Math.ceil((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
        
        // Atualizar status se necessÃ¡rio
        if (diffDias < 0 && mensalista.status !== 'vencido') {
            mensalista.status = 'vencido';
            vencidosParaNotificar.push(mensalista);
        } else if (diffDias === 0 && mensalista.status !== 'vencido') {
            mensalista.status = 'pendente';
            proximosParaNotificar.push(mensalista);
        } else if (diffDias > 0 && diffDias <= diasAlerta && mensalista.status === 'pendente') {
            proximosParaNotificar.push(mensalista);
        }
    });
    
    // Salvar alteraÃ§Ãµes de status
    if (vencidosParaNotificar.length > 0 || proximosParaNotificar.length > 0) {
        salvarDados();
    }
    
    // Gerar alertas visuais
    if (vencidosParaNotificar.length > 0) {
        alertasHTML += `
            <div class="notificacao">
                <div class="notificacao-titulo">âš ï¸ ${vencidosParaNotificar.length} MENSALISTA(S) VENCIDO(S)</div>
                <div style="display: grid; gap: 8px; margin-top: 10px;">
                    ${vencidosParaNotificar.slice(0, 3).map(m => `
                        <div class="notificacao-mensalista">
                            <div>
                                <div style="font-weight: 600;">${m.nome}</div>
                                <div style="font-size: 12px; color: #ff9999;">
                                    ${m.barbeiro} â€¢ Venceu ${formatarDataBR(m.dataVencimento)}
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button class="action-btn success" onclick="pagarMensalidade(${m.id})">
                                    ğŸ’°
                                </button>
                                <button class="action-btn whatsapp" onclick="enviarLembreteMensalista(${m.id})">
                                    ğŸ“±
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${vencidosParaNotificar.length > 3 ? `
                    <div style="text-align: center; margin-top: 10px; color: #ff9999; font-size: 12px;">
                        + ${vencidosParaNotificar.length - 3} outros vencidos
                    </div>
                ` : ''}
                <button class="btn btn-danger" onclick="filtrarMensalistasPorStatus('vencido')" style="margin-top: 15px; width: 100%;">
                    ğŸ‘ï¸ Ver Todos os Vencidos
                </button>
            </div>
        `;
    }
    
    if (proximosParaNotificar.length > 0) {
        alertasHTML += `
            <div class="notificacao" style="background: linear-gradient(135deg, rgba(255,149,0,0.1), rgba(255,149,0,0.05)); border-color: rgba(255,149,0,0.3);">
                <div class="notificacao-titulo" style="color: #FF9500;">â° ${proximosParaNotificar.length} VENCIMENTO(S) PRÃ“XIMO(S)</div>
                <div style="display: grid; gap: 8px; margin-top: 10px;">
                    ${proximosParaNotificar.slice(0, 3).map(m => {
                        const dataVenc = new Date(m.dataVencimento || m.vencimento);
                        const diffDias = Math.ceil((dataVenc - hoje) / (1000 * 60 * 60 * 24));
                        return `
                            <div class="notificacao-mensalista" style="background: rgba(255,149,0,0.1);">
                                <div>
                                    <div style="font-weight: 600;">${m.nome}</div>
                                    <div style="font-size: 12px; color: #ffb366;">
                                        ${m.barbeiro} â€¢ Vence em ${diffDias} ${diffDias === 1 ? 'dia' : 'dias'}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="action-btn whatsapp" onclick="enviarLembreteMensalista(${m.id})">
                                        ğŸ“±
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    document.getElementById('alertasVencimento').innerHTML = alertasHTML;
    
    // Mostrar notificaÃ§Ã£o push se houver vencidos
    if (vencidosParaNotificar.length > 0 && !notificacaoAtiva) {
        mostrarNotificacaoPush(vencidosParaNotificar);
    }
    
    // Atualizar listas
    atualizarResumoStatusMensalistas();
    if (filtroStatusAtual !== 'todos') {
        filtrarMensalistasPorStatus(filtroStatusAtual);
    }
}

function mostrarNotificacaoPush(mensalistas) {
    if (!dados.config.notificacoesAtivas) return;
    
    const notificacao = document.getElementById('pushNotification');
    const title = document.getElementById('pushNotificationTitle');
    const message = document.getElementById('pushNotificationMessage');
    
    if (!notificacao || !title || !message) return;
    
    if (mensalistas.length === 1) {
        title.innerHTML = 'âš ï¸ MENSALISTA VENCIDO';
        message.textContent = `${mensalistas[0].nome} estÃ¡ com mensalidade vencida!`;
    } else {
        title.innerHTML = `âš ï¸ ${mensalistas.length} MENSALISTAS VENCIDOS`;
        message.textContent = `${mensalistas.slice(0, 2).map(m => m.nome).join(', ')}${mensalistas.length > 2 ? ' e outros' : ''} estÃ£o vencidos!`;
    }
    
    notificacao.style.display = 'block';
    notificacaoAtiva = true;
    
    // Tocar som de alerta
    try {
        document.getElementById('alertSound').play();
    } catch (error) {
        console.log('Som de alerta nÃ£o disponÃ­vel');
    }
    
    // Auto-fechar apÃ³s 10 segundos
    setTimeout(() => {
        fecharNotificacao();
    }, 10000);
}

function fecharNotificacao() {
    const notificacao = document.getElementById('pushNotification');
    if (notificacao) {
        notificacao.style.display = 'none';
        notificacaoAtiva = false;
    }
}

function notificarTodosMensalistas() {
    const mensalistasPendentes = dados.mensalistas.filter(m => m.status === 'pendente' || m.status === 'vencido');
    
    if (mensalistasPendentes.length === 0) {
        alert('âœ… NÃ£o hÃ¡ mensalistas pendentes para notificar!');
        return;
    }
    
    if (!confirm(`ğŸ“¢ Enviar notificaÃ§Ãµes para ${mensalistasPendentes.length} mensalista(s)?\n\nEsta aÃ§Ã£o enviarÃ¡ mensagens de lembrete via WhatsApp.`)) {
        return;
    }
    
    // Filtrar apenas os que tÃªm telefone
    const mensalistasComTelefone = mensalistasPendentes.filter(m => m.telefone && m.telefone.replace(/\D/g, '').length >= 11);
    
    if (mensalistasComTelefone.length === 0) {
        alert('âŒ Nenhum mensalista com telefone vÃ¡lido encontrado!');
        return;
    }
    
    // Mostrar progresso
    let progresso = 0;
    const total = mensalistasComTelefone.length;
    
    const enviarProximo = () => {
        if (progresso < total) {
            const mensalista = mensalistasComTelefone[progresso];
            enviarLembreteMensalista(mensalista.id);
            progresso++;
            
            // Atualizar interface
            const notificacao = document.getElementById('pushNotification');
            notificacao.style.display = 'block';
            notificacao.style.background = 'linear-gradient(135deg, rgba(37,211,102,0.9), rgba(18,140,126,0.9))';
            document.getElementById('pushNotificationTitle').innerHTML = `ğŸ“± ENVIANDO NOTIFICAÃ‡Ã•ES`;
            document.getElementById('pushNotificationMessage').textContent = `${progresso}/${total} â€¢ ${mensalista.nome}`;
            
            // PrÃ³ximo apÃ³s 3 segundos
            setTimeout(enviarProximo, 3000);
        } else {
            // ConcluÃ­do
            const notificacao = document.getElementById('pushNotification');
            notificacao.style.background = 'linear-gradient(135deg, rgba(37,211,102,0.9), rgba(18,140,126,0.9))';
            document.getElementById('pushNotificationTitle').innerHTML = `âœ… CONCLUÃDO`;
            document.getElementById('pushNotificationMessage').textContent = `${total} notificaÃ§Ãµes enviadas!`;
            
            setTimeout(() => {
                fecharNotificacao();
                alert(`âœ… ${total} notificaÃ§Ãµes enviadas com sucesso!`);
            }, 3000);
        }
    };
    
    // Iniciar envio
    enviarProximo();
}

// ========== CRUD MENSALISTAS ==========
function adicionarOuAtualizarMensalista() {
    const nome = document.getElementById('nomeMensalista').value.trim();
    const telefone = document.getElementById('telefoneMensalista').value.trim();
    const barbeiro = document.getElementById('barbeiroMensalista').value;
    const valor = parseFloat(document.getElementById('valorMensalista').value);
    const dataInicio = document.getElementById('dataInicioMensalista').value;
    const diaVencimento = parseInt(document.getElementById('diaVencimentoMensalista').value);
    const status = document.getElementById('statusMensalista').value;
    const observacoes = document.getElementById('observacoesMensalista').value.trim();
    
    if (!nome || !barbeiro || isNaN(valor) || !dataInicio || !diaVencimento) {
        alert('âŒ Preencha todos os campos obrigatÃ³rios!');
        return;
    }
    
    if (editandoMensalistaId) {
        // Atualizar mensalista existente
        atualizarMensalista(editandoMensalistaId, nome, telefone, barbeiro, valor, dataInicio, diaVencimento, status, observacoes);
    } else {
        // Adicionar novo mensalista
        adicionarNovoMensalista(nome, telefone, barbeiro, valor, dataInicio, diaVencimento, status, observacoes);
    }
}

function adicionarNovoMensalista(nome, telefone, barbeiro, valor, dataInicio, diaVencimento, status, observacoes) {
    // Gerar ID Ãºnico
    const id = dados.mensalistas.length > 0 ? Math.max(...dados.mensalistas.map(m => m.id)) + 1 : 1;
    
    // Calcular data de vencimento
    const dataInicioObj = new Date(dataInicio);
    let dataVencimento = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth(), diaVencimento);
    
    // Se o dia de vencimento for menor que o dia atual, vai para o prÃ³ximo mÃªs
    if (dataVencimento < dataInicioObj) {
        dataVencimento = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth() + 1, diaVencimento);
    }
    
    const novoMensalista = {
        id: id,
        nome: nome,
        telefone: telefone,
        barbeiro: barbeiro,
        valor: valor,
        dataInicio: dataInicio,
        diaVencimento: diaVencimento,
        dataVencimento: dataVencimento.toISOString().split('T')[0],
        status: status,
        observacoes: observacoes,
        historicoPagamentos: []
    };
    
    dados.mensalistas.push(novoMensalista);
    salvarDados();
    
    // Limpar formulÃ¡rio
    limparFormMensalista();
    
    // Atualizar interface
    atualizarDashboardCompleto();
    
    // Fechar modal se estiver aberto
    fecharModal('modalMensalistas');
    
    // Mostrar confirmaÃ§Ã£o
    alert(`âœ… Mensalista "${nome}" cadastrado com sucesso!`);
}

function atualizarMensalista(id, nome, telefone, barbeiro, valor, dataInicio, diaVencimento, status, observacoes) {
    const mensalista = dados.mensalistas.find(m => m.id === id);
    if (!mensalista) {
        alert('âŒ Mensalista nÃ£o encontrado!');
        return;
    }
    
    // Atualizar dados
    mensalista.nome = nome;
    mensalista.telefone = telefone;
    mensalista.barbeiro = barbeiro;
    mensalista.valor = valor;
    mensalista.dataInicio = dataInicio;
    mensalista.diaVencimento = diaVencimento;
    mensalista.status = status;
    mensalista.observacoes = observacoes;
    
    // Recalcular vencimento se necessÃ¡rio
    if (diaVencimento !== mensalista.diaVencimento || dataInicio !== mensalista.dataInicio) {
        const dataInicioObj = new Date(dataInicio);
        let dataVencimento = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth(), diaVencimento);
        
        if (dataVencimento < dataInicioObj) {
            dataVencimento = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth() + 1, diaVencimento);
        }
        
        mensalista.dataVencimento = dataVencimento.toISOString().split('T')[0];
    }
    
    salvarDados();
    
    // Resetar modo ediÃ§Ã£o
    editandoMensalistaId = null;
    document.getElementById('btnAdicionarMensalista').textContent = 'âœ… Cadastrar Mensalista';
    
    // Limpar formulÃ¡rio
    limparFormMensalista();
    
    // Atualizar interface
    atualizarDashboardCompleto();
    
    // Fechar modal
    fecharModal('modalMensalistas');
    
    alert(`âœ… Mensalista "${nome}" atualizado com sucesso!`);
}

function editarMensalista(id) {
    const mensalista = dados.mensalistas.find(m => m.id === id);
    if (!mensalista) {
        alert('âŒ Mensalista nÃ£o encontrado!');
        return;
    }
    
    // Preencher formulÃ¡rio
    document.getElementById('nomeMensalista').value = mensalista.nome;
    document.getElementById('telefoneMensalista').value = mensalista.telefone || '';
    document.getElementById('barbeiroMensalista').value = mensalista.barbeiro;
    document.getElementById('valorMensalista').value = mensalista.valor;
    document.getElementById('dataInicioMensalista').value = mensalista.dataInicio;
    document.getElementById('diaVencimentoMensalista').value = mensalista.diaVencimento;
    document.getElementById('statusMensalista').value = mensalista.status;
    document.getElementById('observacoesMensalista').value = mensalista.observacoes || '';
    
    // Mudar para modo ediÃ§Ã£o
    editandoMensalistaId = id;
    document.getElementById('btnAdicionarMensalista').textContent = 'ğŸ’¾ Atualizar Mensalista';
    
    // Abrir modal
    abrirModalMensalistas();
}

function pagarMensalidade(id) {
    const mensalista = dados.mensalistas.find(m => m.id === id);
    if (!mensalista) {
        alert('âŒ Mensalista nÃ£o encontrado!');
        return;
    }
    
    const hoje = new Date();
    const confirmar = confirm(`ğŸ’µ Registrar pagamento de R$ ${mensalista.valor.toFixed(2)} para ${mensalista.nome}?`);
    
    if (!confirmar) return;
    
    // Registrar pagamento
    if (!mensalista.historicoPagamentos) {
        mensalista.historicoPagamentos = [];
    }
    
    mensalista.historicoPagamentos.push({
        data: hoje.toISOString().split('T')[0],
        valor: mensalista.valor,
        pagoPor: 'Sistema'
    });
    
    // Atualizar status e calcular prÃ³ximo vencimento
    mensalista.status = 'pago';
    mensalista.dataUltimoPagamento = hoje.toISOString().split('T')[0];
    
    // Calcular prÃ³ximo vencimento
    const dataVencimentoAtual = new Date(mensalista.dataVencimento);
    const proximoVencimento = new Date(dataVencimentoAtual.getFullYear(), dataVencimentoAtual.getMonth() + 1, mensalista.diaVencimento);
    mensalista.dataVencimento = proximoVencimento.toISOString().split('T')[0];
    
    salvarDados();
    
    // Atualizar interface
    atualizarDashboardCompleto();
    
    alert(`âœ… Pagamento de R$ ${mensalista.valor.toFixed(2)} registrado para ${mensalista.nome}!`);
}

function removerMensalista(id) {
    if (!confirm('âš ï¸ Tem certeza que deseja remover este mensalista?')) {
        return;
    }
    
    const index = dados.mensalistas.findIndex(m => m.id === id);
    if (index === -1) {
        alert('âŒ Mensalista nÃ£o encontrado!');
        return;
    }
    
    const nomeRemovido = dados.mensalistas[index].nome;
    dados.mensalistas.splice(index, 1);
    salvarDados();
    
    // Atualizar interface
    atualizarDashboardCompleto();
    
    alert(`ğŸ—‘ï¸ Mensalista "${nomeRemovido}" removido com sucesso!`);
}

function enviarLembreteMensalista(id) {
    const mensalista = dados.mensalistas.find(m => m.id === id);
    if (!mensalista) {
        alert('âŒ Mensalista nÃ£o encontrado!');
        return;
    }
    
    if (!mensalista.telefone || mensalista.telefone.replace(/\D/g, '').length < 11) {
        alert('âŒ NÃºmero de telefone invÃ¡lido para envio de mensagem!');
        return;
    }
    
    const hoje = new Date();
    const dataVencimento = new Date(mensalista.dataVencimento);
    const diasAteVencimento = Math.ceil((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
    
    let mensagem = '';
    if (mensalista.status === 'vencido') {
        mensagem = `*LEMBRETE MENSALIDADE VENCIDA*%0A%0A` +
                  `OlÃ¡ ${mensalista.nome},%0A%0A` +
                  `Sua mensalidade estÃ¡ *VENCIDA*!%0A` +
                  `Valor: R$ ${mensalista.valor.toFixed(2)}%0A` +
                  `Vencimento: ${formatarDataBR(mensalista.dataVencimento)}%0A` +
                  `Barbeiro: ${mensalista.barbeiro}%0A%0A` +
                  `*Por favor, regularize o pagamento.*%0A%0A` +
                  `BarbaPRO Duo`;
    } else if (mensalista.status === 'pendente') {
        mensagem = `*LEMBRETE MENSALIDADE*%0A%0A` +
                  `OlÃ¡ ${mensalista.nome},%0A%0A` +
                  `Lembrete da sua mensalidade:%0A` +
                  `Valor: R$ ${mensalista.valor.toFixed(2)}%0A` +
                  `Vencimento: ${formatarDataBR(mensalista.dataVencimento)}%0A` +
                  `Vence em: ${diasAteVencimento} ${diasAteVencimento === 1 ? 'dia' : 'dias'}%0A` +
                  `Barbeiro: ${mensalista.barbeiro}%0A%0A` +
                  `*Obrigado pela preferÃªncia!*%0A%0A` +
                  `BarbaPRO Duo`;
    } else {
        mensagem = `*CONFIRMAÃ‡ÃƒO DE PAGAMENTO*%0A%0A` +
                  `OlÃ¡ ${mensalista.nome},%0A%0A` +
                  `Pagamento confirmado!%0A` +
                  `Valor: R$ ${mensalista.valor.toFixed(2)}%0A` +
                  `PrÃ³ximo vencimento: ${formatarDataBR(mensalista.dataVencimento)}%0A` +
                  `Barbeiro: ${mensalista.barbeiro}%0A%0A` +
                  `*Obrigado pela preferÃªncia!*%0A%0A` +
                  `BarbaPRO Duo`;
    }
    
    const telefoneFormatado = mensalista.telefone.replace(/\D/g, '');
    const urlWhatsApp = `https://wa.me/55${telefoneFormatado}?text=${mensagem}`;
    
    // Abrir em nova aba
    window.open(urlWhatsApp, '_blank');
}

function enviarLembretesMensalistas() {
    const mensalistasPendentes = dados.mensalistas.filter(m => m.status === 'pendente' || m.status === 'vencido');
    
    if (mensalistasPendentes.length === 0) {
        alert('âœ… NÃ£o hÃ¡ mensalistas pendentes para enviar lembretes!');
        return;
    }
    
    notificarTodosMensalistas();
}

function limparFormMensalista() {
    document.getElementById('nomeMensalista').value = '';
    document.getElementById('telefoneMensalista').value = '';
    document.getElementById('valorMensalista').value = '';
    document.getElementById('observacoesMensalista').value = '';
    
    // Resetar valores padrÃ£o
    const hoje = new Date();
    document.getElementById('dataInicioMensalista').value = hoje.toISOString().split('T')[0];
    document.getElementById('diaVencimentoMensalista').value = hoje.getDate();
    
    // Resetar modo ediÃ§Ã£o
    editandoMensalistaId = null;
    document.getElementById('btnAdicionarMensalista').textContent = 'âœ… Cadastrar Mensalista';
}

// ========== FUNÃ‡Ã•ES DE SERVIÃ‡OS ==========
function atualizarListaServicosRecentes() {
    const dataInicio = document.getElementById('dataInicioServicos').value;
    const dataFim = document.getElementById('dataFimServicos').value;
    const filtroBarbeiro = document.getElementById('filtroBarbeiroServicos').value;
    const filtroPagamento = document.getElementById('filtroPagamentoServicos').value;
    
    let todosServicos = [...dados.Gabriel, ...dados.Wagner];
    
    // Aplicar filtros
    if (dataInicio && dataFim) {
        todosServicos = todosServicos.filter(servico => {
            // Filtro por data
            if (servico.data < dataInicio || servico.data > dataFim) return false;
            
            // Filtro por barbeiro
            if (filtroBarbeiro !== 'todos' && servico.barbeiro !== filtroBarbeiro) return false;
            
            // Filtro por pagamento
            if (filtroPagamento === 'pago' && !servico.pago) return false;
            if (filtroPagamento === 'fiado' && servico.pago) return false;
            
            return true;
        });
    }
    
    // Ordenar por data e hora (mais recente primeiro)
    todosServicos.sort((a, b) => {
        const dataA = new Date(a.data + 'T' + (a.hora || '00:00'));
        const dataB = new Date(b.data + 'T' + (b.hora || '00:00'));
        return dataB - dataA;
    });
    
    // Calcular totais filtrados
    const totalFiltrado = todosServicos.reduce((sum, s) => sum + s.valor, 0);
    const totalPagoFiltrado = todosServicos.filter(s => s.pago).reduce((sum, s) => sum + s.valor, 0);
    
    let html = '';
    
    if (todosServicos.length > 0) {
        html = `
            <div style="background: rgba(255,255,255,0.03); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div>
                        <div style="font-size: 12px; color: #aaa;">TOTAL FILTRADO</div>
                        <div style="font-size: 24px; font-weight: 700; color: #ffaa00;">R$ ${totalFiltrado.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #aaa;">SERVIÃ‡OS</div>
                        <div style="font-size: 24px; font-weight: 700; color: #fff;">${todosServicos.length}</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #aaa;">RECEBIDO</div>
                        <div style="font-size: 20px; font-weight: 600; color: #25D366;">R$ ${totalPagoFiltrado.toFixed(2)}</div>
                    </div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ğŸ“… Data</th>
                        <th>â° Hora</th>
                        <th>ğŸ‘¤ Barbeiro</th>
                        <th>âœ‚ï¸ ServiÃ§o</th>
                        <th>ğŸ‘¤ Cliente</th>
                        <th>ğŸ’° Valor</th>
                        <th>ğŸ’³ Pagamento</th>
                        <th>ğŸ“Š Status</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        todosServicos.slice(0, 50).forEach(servico => {
            const statusClass = servico.pago ? 'status-pago' : 'status-pendente';
            const statusTexto = servico.pago ? 'PAGO' : 'FIADO';
            const metodoPagamento = servico.metodoPagamento || 'N/A';
            
            let metodoIcon = 'ğŸ’°';
            switch(metodoPagamento) {
                case 'dinheiro': metodoIcon = 'ğŸ’µ'; break;
                case 'pix': metodoIcon = 'ğŸ“±'; break;
                case 'debito': metodoIcon = 'ğŸ’³'; break;
                case 'credito': metodoIcon = 'ğŸ’³'; break;
            }
            
            html += `
                <tr>
                    <td>${formatarDataBR(servico.data)}</td>
                    <td>${servico.hora}</td>
                    <td>
                        <span class="badge ${servico.barbeiro === 'Gabriel' ? 'badge-warning' : 'badge-success'}">
                            ${servico.barbeiro}
                        </span>
                    </td>
                    <td>${servico.tipo}</td>
                    <td>${servico.cliente}</td>
                    <td style="font-weight: 600; color: #ffaa00;">R$ ${servico.valor.toFixed(2)}</td>
                    <td>${metodoIcon} ${metodoPagamento.toUpperCase()}</td>
                    <td><span class="status-tag ${statusClass}">${statusTexto}</span></td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
            
            <div style="text-align: center; margin-top: 20px; color: #aaa; font-size: 14px;">
                Mostrando ${Math.min(todosServicos.length, 50)} de ${todosServicos.length} serviÃ§os
                ${todosServicos.length > 50 ? '(use filtros para ver mais)' : ''}
            </div>
        `;
    } else {
        html = `
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“</div>
                <div class="empty-state-title">Nenhum serviÃ§o encontrado</div>
                <div class="empty-state-subtitle">
                    Tente ajustar os filtros ou datas
                </div>
            </div>
        `;
    }
    
    document.getElementById('listaServicosRecentes').innerHTML = html;
}

function exportarDadosServicos() {
    const dataInicio = document.getElementById('dataInicioServicos').value;
    const dataFim = document.getElementById('dataFimServicos').value;
    const filtroBarbeiro = document.getElementById('filtroBarbeiroServicos').value;
    const filtroPagamento = document.getElementById('filtroPagamentoServicos').value;
    
    let servicos = [...dados.Gabriel, ...dados.Wagner].filter(s => {
        if (s.data < dataInicio || s.data > dataFim) return false;
        if (filtroBarbeiro !== 'todos' && s.barbeiro !== filtroBarbeiro) return false;
        if (filtroPagamento === 'pago' && !s.pago) return false;
        if (filtroPagamento === 'fiado' && s.pago) return false;
        return true;
    });
    
    // Converter para CSV
    let csv = 'Data,Hora,Barbeiro,Cliente,ServiÃ§o,Valor,Status Pagamento,MÃ©todo Pagamento,ObservaÃ§Ãµes\n';
    
    servicos.forEach(s => {
        const linha = [
            s.data,
            s.hora,
            s.barbeiro,
            s.cliente,
            s.tipo,
            s.valor.toFixed(2),
            s.pago ? 'PAGO' : 'FIADO',
            s.metodoPagamento || 'N/A',
            s.observacoes || ''
        ].map(campo => `"${campo}"`).join(',');
        
        csv += linha + '\n';
    });
    
    // Criar arquivo e baixar
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `servicos_${dataInicio}_a_${dataFim}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`ğŸ“¥ Arquivo CSV gerado com ${servicos.length} serviÃ§os!`);
}

// ========== MODAIS ==========
function abrirModalResumoCompleto() {
    const hoje = new Date();
    const mesAtual = hoje.getMonth();
    const anoAtual = hoje.getFullYear();
    
    // Calcular totais Gabriel
    const servicosGabrielMes = dados.Gabriel.filter(s => {
        const dataServico = new Date(s.data);
        return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
    });
    
    const totalGabriel = servicosGabrielMes.reduce((sum, s) => sum + s.valor, 0);
    const fiadoGabriel = servicosGabrielMes.filter(s => !s.pago).reduce((sum, s) => sum + s.valor, 0);
    const pagoGabriel = totalGabriel - fiadoGabriel;
    const mediaGabriel = servicosGabrielMes.length > 0 ? (totalGabriel / servicosGabrielMes.length) : 0;
    
    // Calcular totais Wagner
    const servicosWagnerMes = dados.Wagner.filter(s => {
        const dataServico = new Date(s.data);
        return dataServico.getMonth() === mesAtual && dataServico.getFullYear() === anoAtual;
    });
    
    const totalWagner = servicosWagnerMes.reduce((sum, s) => sum + s.valor, 0);
    const fiadoWagner = servicosWagnerMes.filter(s => !s.pago).reduce((sum, s) => sum + s.valor, 0);
    const pagoWagner = totalWagner - fiadoWagner;
    const mediaWagner = servicosWagnerMes.length > 0 ? (totalWagner / servicosWagnerMes.length) : 0;
    
    // Despesas do mÃªs
    const despesasMes = dados.despesas.filter(d => {
        const dataDespesa = new Date(d.data);
        return dataDespesa.getMonth() === mesAtual && dataDespesa.getFullYear() === anoAtual;
    });
    
    const totalDespesas = despesasMes.reduce((sum, d) => sum + d.valor, 0);
    
    // Totais gerais
    const totalMes = totalGabriel + totalWagner;
    const totalFiado = fiadoGabriel + fiadoWagner;
    const totalPago = pagoGabriel + pagoWagner;
    const totalServicos = servicosGabrielMes.length + servicosWagnerMes.length;
    const lucroLiquido = totalMes - totalDespesas;
    
    const html = `
        <div style="background: linear-gradient(135deg, rgba(255,170,0,0.1), rgba(51,102,255,0.1)); border-radius: 15px; padding: 25px; margin-bottom: 25px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 24px; font-weight: 800; color: #ffaa00;">ğŸ“Š RESUMO DO MÃŠS</div>
                <div style="color: #aaa; font-size: 14px;">${hoje.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'}).toUpperCase()}</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px;">
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: #aaa;">TOTAL GABRIEL</div>
                    <div style="font-size: 32px; font-weight: 800; color: #ffaa00; margin: 10px 0;">R$ ${totalGabriel.toFixed(2)}</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px;">
                        <div>
                            <div style="color: #25D366;">âœ… R$ ${pagoGabriel.toFixed(2)}</div>
                            <div>Recebido</div>
                        </div>
                        <div>
                            <div style="color: #FF9500;">â³ R$ ${fiadoGabriel.toFixed(2)}</div>
                            <div>Fiado</div>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: #aaa;">TOTAL WAGNER</div>
                    <div style="font-size: 32px; font-weight: 800; color: #3366ff; margin: 10px 0;">R$ ${totalWagner.toFixed(2)}</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 12px;">
                        <div>
                            <div style="color: #25D366;">âœ… R$ ${pagoWagner.toFixed(2)}</div>
                            <div>Recebido</div>
                        </div>
                        <div>
                            <div style="color: #FF9500;">â³ R$ ${fiadoWagner.toFixed(2)}</div>
                            <div>Fiado</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; background: rgba(255,51,102,0.1); padding: 20px; border-radius: 12px;">
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: #ff99bb;">DESPESAS MÃŠS</div>
                    <div style="font-size: 24px; font-weight: 800; color: #ff3366; margin: 10px 0;">R$ ${totalDespesas.toFixed(2)}</div>
                    <div style="font-size: 14px; color: #aaa;">${despesasMes.length} despesas registradas</div>
                </div>
                
                <div style="text-align: center;">
                    <div style="font-size: 12px; color: ${lucroLiquido >= 0 ? '#25D366' : '#ff3366'};">LUCRO LÃQUIDO</div>
                    <div style="font-size: 32px; font-weight: 800; color: ${lucroLiquido >= 0 ? '#25D366' : '#ff3366'}; margin: 10px 0;">R$ ${lucroLiquido.toFixed(2)}</div>
                    <div style="font-size: 14px; color: #aaa;">Receita - Despesas</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                <div>
                    <div style="font-size: 12px; color: #aaa;">RECEITA TOTAL</div>
                    <div style="font-size: 18px; font-weight: 700; color: #25D366;">R$ ${totalMes.toFixed(2)}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #aaa;">SERVIÃ‡OS</div>
                    <div style="font-size: 18px; font-weight: 700; color: #fff;">${totalServicos}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #aaa;">MÃ‰DIA/SERVIÃ‡O</div>
                    <div style="font-size: 18px; font-weight: 700; color: #ffaa00;">R$ ${(totalMes / totalServicos || 0).toFixed(2)}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #aaa;">% FIADO</div>
                    <div style="font-size: 18px; font-weight: 700; color: ${totalFiado > totalMes * 0.3 ? '#ff3366' : '#FF9500'};">${totalMes > 0 ? ((totalFiado / totalMes) * 100).toFixed(1) : '0'}%</div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('conteudoResumo').innerHTML = html;
    document.getElementById('modalResumo').style.display = 'flex';
}

function abrirModalPagamentos() {
    document.getElementById('modalPagamentos').style.display = 'flex';
    gerarRelatorioPagamentosDetalhado();
}

function gerarRelatorioPagamentosDetalhado() {
    const dataInicio = document.getElementById('dataInicioPagamentos').value;
    const dataFim = document.getElementById('dataFimPagamentos').value;
    const filtroBarbeiro = document.getElementById('filtroBarbeiroPagamentos').value;
    
    // Coletar serviÃ§os no perÃ­odo
    let todosServicos = [...dados.Gabriel, ...dados.Wagner].filter(s => {
        return s.data >= dataInicio && s.data <= dataFim;
    });
    
    if (filtroBarbeiro !== 'todos') {
        todosServicos = todosServicos.filter(s => s.barbeiro === filtroBarbeiro);
    }
    
    // Calcular totais
    const totalPeriodo = todosServicos.reduce((sum, s) => sum + s.valor, 0);
    const totalPago = todosServicos.filter(s => s.pago).reduce((sum, s) => sum + s.valor, 0);
    const totalFiado = totalPeriodo - totalPago;
    
    // Gerar HTML
    let html = `
        <div style="background: linear-gradient(135deg, rgba(255,170,0,0.1), rgba(51,102,255,0.1)); border-radius: 15px; padding: 25px; margin-bottom: 25px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 20px; font-weight: 800; color: #ffaa00;">ğŸ’° RELATÃ“RIO DE PAGAMENTOS</div>
                <div style="color: #aaa; font-size: 14px;">${formatarDataBR(dataInicio)} Ã  ${formatarDataBR(dataFim)}</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center; margin-bottom: 20px;">
                <div>
                    <div style="font-size: 12px; color: #aaa;">TOTAL PERÃODO</div>
                    <div style="font-size: 24px; font-weight: 800; color: #25D366;">R$ ${totalPeriodo.toFixed(2)}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #aaa;">SERVIÃ‡OS</div>
                    <div style="font-size: 24px; font-weight: 800; color: #fff;">${todosServicos.length}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #aaa;">RECEBIDO</div>
                    <div style="font-size: 20px; font-weight: 700; color: #25D366;">R$ ${totalPago.toFixed(2)}</div>
                </div>
                <div>
                    <div style="font-size: 12px; color: #aaa;">FIADO</div>
                    <div style="font-size: 20px; font-weight: 700; color: #FF9500;">R$ ${totalFiado.toFixed(2)}</div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('relatorioPagamentosDetalhado').innerHTML = html;
}

function abrirModalMensalistas() {
    document.getElementById('modalMensalistas').style.display = 'flex';
}

function abrirModalConfiguracoes() {
    // Preencher valores atuais
    document.getElementById('numWhats').value = dados.config.whatsapp || '';
    document.getElementById('novoPin').value = '';
    document.getElementById('valCorte').value = dados.config.corte || 28;
    document.getElementById('valBarba').value = dados.config.barba || 15;
    document.getElementById('valCombo').value = dados.config.combo || 40;
    document.getElementById('orcamentoDespesas').value = dados.config.orcamentoDespesas || 1500;
    document.getElementById('notificacoesAtivas').value = dados.config.notificacoesAtivas ? 'true' : 'false';
    document.getElementById('diasAlerta').value = dados.config.diasAlerta || 3;
    
    document.getElementById('modalConfig').style.display = 'flex';
}

function salvarConfiguracoes() {
    const whatsapp = document.getElementById('numWhats').value.trim();
    const novoPin = document.getElementById('novoPin').value.trim();
    const corte = parseFloat(document.getElementById('valCorte').value);
    const barba = parseFloat(document.getElementById('valBarba').value);
    const combo = parseFloat(document.getElementById('valCombo').value);
    const orcamentoDespesas = parseFloat(document.getElementById('orcamentoDespesas').value);
    const notificacoesAtivas = document.getElementById('notificacoesAtivas').value === 'true';
    const diasAlerta = parseInt(document.getElementById('diasAlerta').value);
    
    // Validar valores
    if (whatsapp && !/^\d{10,15}$/.test(whatsapp.replace(/\D/g, ''))) {
        alert('âŒ NÃºmero de WhatsApp invÃ¡lido!');
        return;
    }
    
    if (novoPin && !/^\d{4}$/.test(novoPin)) {
        alert('âŒ PIN deve conter 4 dÃ­gitos!');
        return;
    }
    
    if (isNaN(corte) || isNaN(barba) || isNaN(combo) || isNaN(orcamentoDespesas) || isNaN(diasAlerta)) {
        alert('âŒ Valores invÃ¡lidos!');
        return;
    }
    
    // Atualizar configuraÃ§Ãµes
    if (whatsapp) dados.config.whatsapp = whatsapp;
    if (novoPin) dados.config.pin = novoPin;
    dados.config.corte = corte;
    dados.config.barba = barba;
    dados.config.combo = combo;
    dados.config.orcamentoDespesas = orcamentoDespesas;
    dados.config.notificacoesAtivas = notificacoesAtivas;
    dados.config.diasAlerta = diasAlerta;
    
    salvarDados();
    
    // Fechar modal
    fecharModal('modalConfig');
    
    alert('âœ… ConfiguraÃ§Ãµes salvas com sucesso!');
}

function enviarRelatorioWhatsApp(tipo) {
    const numero = dados.config.whatsapp || '11974065186';
    
    if (!numero || numero.length < 10) {
        alert('âŒ Configure um nÃºmero de WhatsApp nas configuraÃ§Ãµes!');
        abrirModalConfiguracoes();
        return;
    }
    
    let mensagem = '';
    const hoje = new Date();
    
    switch(tipo) {
        case 'resumo':
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();
            
            const servicosGabriel = dados.Gabriel.filter(s => {
                const data = new Date(s.data);
                return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
            });
            const servicosWagner = dados.Wagner.filter(s => {
                const data = new Date(s.data);
                return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
            });
            
            const totalGabriel = servicosGabriel.reduce((s, v) => s + v.valor, 0);
            const totalWagner = servicosWagner.reduce((s, v) => s + v.valor, 0);
            const totalMes = totalGabriel + totalWagner;
            const totalServicos = servicosGabriel.length + servicosWagner.length;
            
            mensagem = `*ğŸ“Š RESUMO MENSAL BARBAPRO DUO*%0A%0A` +
                      `PerÃ­odo: ${hoje.toLocaleDateString('pt-BR', {month: 'long', year: 'numeric'})}%0A%0A` +
                      `*GABRIEL:*%0A` +
                      `ServiÃ§os: ${servicosGabriel.length}%0A` +
                      `Total: R$ ${totalGabriel.toFixed(2)}%0A%0A` +
                      `*WAGNER:*%0A` +
                      `ServiÃ§os: ${servicosWagner.length}%0A` +
                      `Total: R$ ${totalWagner.toFixed(2)}%0A%0A` +
                      `*TOTAL GERAL:*%0A` +
                      `ServiÃ§os: ${totalServicos}%0A` +
                      `Faturamento: R$ ${totalMes.toFixed(2)}%0A%0A` +
                      `*BarbaPRO Duo*`;
            break;
            
        case 'servicos':
            const dataInicio = document.getElementById('dataInicioServicos').value;
            const dataFim = document.getElementById('dataFimServicos').value;
            
            const servicosFiltrados = [...dados.Gabriel, ...dados.Wagner].filter(s => 
                s.data >= dataInicio && s.data <= dataFim
            );
            
            const total = servicosFiltrados.reduce((s, v) => s + v.valor, 0);
            const pago = servicosFiltrados.filter(s => s.pago).reduce((s, v) => s + v.valor, 0);
            
            mensagem = `*ğŸ“ RELATÃ“RIO DE SERVIÃ‡OS*%0A%0A` +
                      `PerÃ­odo: ${formatarDataBR(dataInicio)} Ã  ${formatarDataBR(dataFim)}%0A` +
                      `ServiÃ§os: ${servicosFiltrados.length}%0A` +
                      `Total: R$ ${total.toFixed(2)}%0A` +
                      `Recebido: R$ ${pago.toFixed(2)}%0A` +
                      `Fiado: R$ ${(total - pago).toFixed(2)}%0A%0A` +
                      `*BarbaPRO Duo*`;
            break;
            
        case 'pagamentos':
            const dataInicioPag = document.getElementById('dataInicioPagamentos').value;
            const dataFimPag = document.getElementById('dataFimPagamentos').value;
            
            const servicosPeriodo = [...dados.Gabriel, ...dados.Wagner].filter(s => 
                s.data >= dataInicioPag && s.data <= dataFimPag
            );
            
            const totalPeriodo = servicosPeriodo.reduce((s, v) => s + v.valor, 0);
            const totalPagoPeriodo = servicosPeriodo.filter(s => s.pago).reduce((s, v) => s + v.valor, 0);
            
            mensagem = `*ğŸ’° RELATÃ“RIO DE PAGAMENTOS*%0A%0A` +
                      `PerÃ­odo: ${formatarDataBR(dataInicioPag)} Ã  ${formatarDataBR(dataFimPag)}%0A` +
                      `ServiÃ§os: ${servicosPeriodo.length}%0A` +
                      `Total: R$ ${totalPeriodo.toFixed(2)}%0A` +
                      `Recebido: R$ ${totalPagoPeriodo.toFixed(2)}%0A` +
                      `Fiado: R$ ${(totalPeriodo - totalPagoPeriodo).toFixed(2)}%0A%0A` +
                      `*BarbaPRO Duo*`;
            break;
    }
    
    const url = `https://wa.me/55${numero.replace(/\D/g, '')}?text=${mensagem}`;
    window.open(url, '_blank');
}

// ========== FUNÃ‡Ã•ES AUXILIARES ==========
function formatarDataBR(dataString) {
    if (!dataString) return '';
    const date = new Date(dataString);
    return date.toLocaleDateString('pt-BR');
}

function calcularProximoVencimento(dataVencimento) {
    const data = new Date(dataVencimento);
    data.setMonth(data.getMonth() + 1);
    return data.toISOString().split('T')[0];
}

function filtrarPorMetodo(metodo) {
    filtroMetodoAtual = filtroMetodoAtual === metodo ? null : metodo;
    atualizarListaServicosRecentes();
}

function voltarParaRegistro() {
    // Simulando volta para pÃ¡gina de registro
    alert('Voltando para pÃ¡gina de registro...');
    // Em um sistema real, vocÃª redirecionaria para a pÃ¡gina de registro
    // window.location.href = 'registro.html';
}

function fecharModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}
    </script>
</body>
</html>